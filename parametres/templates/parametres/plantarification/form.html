{% extends 'parametres/base.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}
    {% if object %}{% trans "Modifier plan" %}{% else %}{% trans "Créer plan" %}{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="d-flex align-items-center gap-3 mb-4">
        <div class="icon-lg bg-primary bg-opacity-10 text-primary rounded-3">
            <i class="bi bi-{% if object %}pencil-square{% else %}plus-circle{% endif %} fs-4"></i>
        </div>
        <div>
            <h1 class="mb-0">
                {% if object %}{% trans "Modifier le plan tarifaire" %}{% else %}{% trans "Créer un nouveau plan" %}{% endif %}
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'parametres:plantarification_list' %}">{% trans "Plans tarifaires" %}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{% if object %}{% trans "Modification" %}{% else %}{% trans "Création" %}{% endif %}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <div class="card-body">
                <div class="row g-4">
                    <!-- Basic Information -->
                    <div class="col-md-6">
                        <div class="border-bottom pb-3 mb-3">
                            <h5 class="fw-semibold"><i class="bi bi-info-circle me-2 text-primary"></i> {% trans "Informations de base" %}</h5>
                        </div>
                        {{ form.nom|as_crispy_field }}
                        {{ form.niveau|as_crispy_field }}
                        {{ form.prix_mensuel|as_crispy_field }}
                    </div>
                    
                    <!-- Resources -->
                    <div class="col-md-6">
                        <div class="border-bottom pb-3 mb-3">
                            <h5 class="fw-semibold"><i class="bi bi-server me-2 text-primary"></i> {% trans "Ressources incluses" %}</h5>
                        </div>
                        {{ form.utilisateurs_inclus|as_crispy_field }}
                        {{ form.stockage_go|as_crispy_field }}
                    </div>
                    
                    <!-- Modules Section -->
                    <div class="col-12">
                        <div class="border-bottom pb-3 mb-3">
                            <h5 class="fw-semibold"><i class="bi bi-puzzle me-2 text-primary"></i> {% trans "Modules" %}</h5>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">{% trans "Modules inclus" %}</h6>
                                    </div>
                                    <div class="card-body">
                                        {{ form.modules_inclus|as_crispy_field }}
                                        <small class="form-text text-muted">
                                            {% trans "Ces modules sont automatiquement inclus dans ce plan" %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">{% trans "Modules optionnels" %}</h6>
                                    </div>
                                    <div class="card-body">
                                        {{ form.modules_optionnels|as_crispy_field }}
                                        <small class="form-text text-muted">
                                            {% trans "Ces modules peuvent être ajoutés en option" %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Features -->
                    <div class="col-12">
                        <div class="border-bottom pb-3 mb-3">
                            <h5 class="fw-semibold"><i class="bi bi-list-check me-2 text-primary"></i> {% trans "Limites et fonctionnalités" %}</h5>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ form.limites|as_crispy_field }}
                                <small class="form-text text-muted">
                                    {% trans "Format JSON pour les limites spécifiques" %}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Premium Options -->
                    <div class="col-12">
                        <div class="border-bottom pb-3 mb-3">
                            <h5 class="fw-semibold"><i class="bi bi-stars me-2 text-primary"></i> {% trans "Options premium" %}</h5>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    {{ form.support_24h|as_crispy_field }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    {{ form.api_acces|as_crispy_field }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    {{ form.rapports_avances|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="col-12">
                        <div class="border-bottom pb-3 mb-3">
                            <h5 class="fw-semibold"><i class="bi bi-toggle-on me-2 text-primary"></i> {% trans "Statut" %}</h5>
                        </div>
                        <div class="form-check form-switch">
                            {{ form.est_actif|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-footer bg-transparent border-top d-flex justify-content-between py-3">
                <a href="{% url 'parametres:plantarification_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i> {% trans "Annuler" %}
                </a>
                <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-save me-2"></i> {% trans "Enregistrer" %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
<style>
    .form-switch .form-check-input {
        width: 2.5em;
        height: 1.5em;
    }
    .form-switch .form-check-label {
        padding-left: 0.5em;
    }
    .icon-lg {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .card-header.bg-light {
        background-color: rgba(0,0,0,.03) !important;
    }
    .bootstrap-select .dropdown-toggle {
        border: 1px solid #ced4da;
        padding: .375rem .75rem;
    }
    .bootstrap-select.show .dropdown-toggle {
        border-color: #86b7fe;
        box-shadow: 0 0 0 .25rem rgba(13,110,253,.25);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-fr_FR.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize select pickers
    $('select[multiple]').selectpicker({
        liveSearch: true,
        actionsBox: true,
        selectedTextFormat: 'count > 3',
        countSelectedText: '{0} modules sélectionnés',
        noneSelectedText: 'Aucun module sélectionné',
        selectAllText: 'Tout sélectionner',
        deselectAllText: 'Tout désélectionner'
    });
    
    // Refresh select pickers when crispy forms renders them
    $(document).on('crispy_forms:initialized', function() {
        $('select[multiple]').selectpicker('refresh');
    });
});
</script>
{% endblock %}
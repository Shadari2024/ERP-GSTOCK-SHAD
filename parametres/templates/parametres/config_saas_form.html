{% extends 'base.html' %}
{% load static %}
{% load i18n %} {# Pour la traduction des chaînes si nécessaire #}

{% block content %}
<div class="container py-4">
    <div class="card shadow-lg mx-auto" style="max-width: 700px;">
        <div class="card-header bg-gradient-primary text-white text-center py-3 rounded-top">
            <h3 class="mb-0"><i class="fas fa-cogs me-2"></i>{% translate "Configuration SAAS" %}</h3>
            <p class="mb-0">{% translate "Gérez les paramètres globaux de votre entreprise." %}</p>
        </div>
        <div class="card-body p-4">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}

                {# Afficher les messages Django #}
                {% if messages %}
                    <div class="mb-3">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                {# Champ devise_principale #}
                <div class="mb-3">
                    <label for="{{ form.devise_principale.id_for_label }}" class="form-label">{% translate "Devise Principale" %}</label>
                    <select class="form-select" id="{{ form.devise_principale.id_for_label }}" name="{{ form.devise_principale.name }}" required>
                        <option value="">{% translate "Sélectionnez une devise" %}</option>
                        {% for devise in devises %}
                            <option value="{{ devise.id }}" {% if form.devise_principale.value == devise.id %}selected{% endif %}>
                                {{ devise.nom }} ({{ devise.symbole }})
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.devise_principale.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.devise_principale.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text text-muted">{% translate "La devise utilisée par défaut pour toutes les transactions." %}</div>
                </div>

                {# Champ fuseau_horaire #}
                <div class="mb-3">
                    <label for="{{ form.fuseau_horaire.id_for_label }}" class="form-label">{% translate "Fuseau Horaire" %}</label>
                    <select class="form-select" id="{{ form.fuseau_horaire.id_for_label }}" name="{{ form.fuseau_horaire.name }}" required>
                        {% for tz in timezones %}
                            <option value="{{ tz }}" {% if form.fuseau_horaire.value == tz %}selected{% endif %}>
                                {{ tz }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.fuseau_horaire.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.fuseau_horaire.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text text-muted">{% translate "Le fuseau horaire de votre entreprise." %}</div>
                </div>

                {# Champ langue #}
                <div class="mb-3">
                    <label for="{{ form.langue.id_for_label }}" class="form-label">{% translate "Langue par Défaut" %}</label>
                    <select class="form-select" id="{{ form.langue.id_for_label }}" name="{{ form.langue.name }}" required>
                        {% for code, name in languages %}
                            <option value="{{ code }}" {% if form.langue.value == code %}selected{% endif %}>
                                {{ name }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.langue.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.langue.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text text-muted">{% translate "La langue par défaut de l'interface utilisateur." %}</div>
                </div>

                {# Champ expiration_session #}
                <div class="mb-3">
                    <label for="{{ form.expiration_session.id_for_label }}" class="form-label">{% translate "Expiration de Session (minutes)" %}</label>
                    <input type="number" class="form-control" id="{{ form.expiration_session.id_for_label }}" 
                           name="{{ form.expiration_session.name }}" value="{{ form.expiration_session.value|default:30 }}" required min="5" max="1440">
                    {% if form.expiration_session.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.expiration_session.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text text-muted">{% translate "Durée en minutes après laquelle une session inactive expire." %}</div>
                </div>

                {# Champ complexite_mdp #}
                <div class="mb-3">
                    <label for="{{ form.complexite_mdp.id_for_label }}" class="form-label">{% translate "Complexité du Mot de Passe" %}</label>
                    <select class="form-select" id="{{ form.complexite_mdp.id_for_label }}" name="{{ form.complexite_mdp.name }}" required>
                        {% for value, label in form.complexite_mdp.field.choices %}
                            <option value="{{ value }}" {% if form.complexite_mdp.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.complexite_mdp.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.complexite_mdp.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text text-muted">{% translate "Niveau de complexité requis pour les mots de passe des utilisateurs." %}</div>
                </div>

                {# Champ modules_actifs (adapté pour éviter KeyError) #}
                {% if form.modules_actifs %}
                    <div class="mb-3">
                        <label class="form-label">{% translate "Modules Actifs" %}</label>
                        {# Itération directe sur les choix du champ pour garantir l'accès à la valeur et au label #}
                        {% for value, label in form.modules_actifs.field.choices %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       name="{{ form.modules_actifs.html_name }}"
                                       value="{{ value }}"
                                       id="{{ form.modules_actifs.id_for_label }}_{{ forloop.counter0 }}"
                                       {% if value in form.modules_actifs.value %}checked{% endif %}>
                                <label class="form-check-label" for="{{ form.modules_actifs.id_for_label }}_{{ forloop.counter0 }}">
                                    {{ label }}
                                </label>
                            </div>
                        {% endfor %}
                        {% if form.modules_actifs.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.modules_actifs.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text text-muted">{% translate "Sélectionnez les modules fonctionnels pour votre entreprise." %}</div>
                    </div>
                {% endif %}


                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>{% translate "Sauvegarder la Configuration" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 0.75rem;
    }
    .card-header {
        border-radius: 0.75rem 0.75rem 0 0 !important;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); /* Couleurs Bootstrap primary */
    }
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    .form-label {
        font-weight: 600;
        color: #343a40;
    }
    .form-control, .form-select {
        border-radius: 0.35rem;
    }
    .invalid-feedback {
        font-size: 0.875em;
    }
</style>
{% endblock %}

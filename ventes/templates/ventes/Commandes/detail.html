{% extends 'base.html' %}
{% load humanize %}

{% block title %}Détail de la Commande #{{ commande.numero }}{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Détail de la Commande #{{ commande.numero }}</h4>
                        <div class="d-flex align-items-center gap-2">
                            {% if not commande.is_cancelled and not commande.is_final %}
                                <a href="{% url 'ventes:commande_update' commande.pk %}" class="btn btn-warning btn-sm"><i class="fas fa-edit"></i> Modifier</a>
                            {% endif %}

                            <a href="{% url 'ventes:commande_change_status' commande.pk %}" class="btn btn-info btn-sm"><i class="fas fa-sync-alt"></i> Statut</a>
                            
                            {# BOUTON IMPRIMER #}
                            <a href="{% url 'ventes:commande_print' commande.pk %}" class="btn btn-secondary btn-sm" target="_blank" title="Imprimer le bon de commande">
                                <i class="fas fa-print"></i> Imprimer
                            </a>
                              
                            {# BOUTON GÉNÉRER BON DE LIVRAISON #}
                            {% if commande.statut == 'Confirmee' or commande.statut == 'livre' %}
                                <form method="post" action="{% url 'ventes:commande_convert_bl' pk=commande.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success btn-sm" title="Générer un bon de livraison à partir de cette commande">
                                        <i class="fas fa-truck"></i> Bon Livraison
                                    </button>
                                </form>
                            {% endif %}

                            {# BOUTON ENVOYER EMAIL #}
                            <form action="{% url 'ventes:commande_send_email' commande.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm" title="Envoyer le bon de commande par email">
                                    <i class="fas fa-envelope"></i> Email
                                </button>
                            </form>

                            {% if not commande.is_final %}
                                <form action="{% url 'ventes:commande_cancel' commande.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Êtes-vous sûr de vouloir annuler cette commande ? Cette action est irréversible.');">
                                        <i class="fas fa-ban"></i> Annuler
                                    </button>
                                </form>
                            {% endif %}

                            {% if perms.ventes.delete_commande %}
                                <a href="{% url 'ventes:commande_delete' commande.pk %}" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash-alt"></i> Supprimer</a>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Client :</strong> {{ commande.client.nom }}</p>
                                {% if commande.devis %}
                                    <p><strong>Issu du Devis :</strong> <a href="{% url 'ventes:devis_detail' commande.devis.pk %}">{{ commande.devis.numero }}</a></p>
                                {% endif %}
                                <p><strong>Date de Commande :</strong> {{ commande.date|date:"d/m/Y" }}</p>
                                <p><strong>Statut :</strong> 
                                    {% if commande.statut == 'annule' %}
                                        <span class="badge bg-warning">Annulée</span>
                                    {% elif commande.statut == 'livre' %}
                                        <span class="badge bg-success">Livrée</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ commande.get_statut_display }}</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6 text-end">
                                <p><strong>Total HT :</strong> {{ commande.total_ht|intcomma }} {{ devise_principale_symbole }}</p>
                                <p><strong>Total TVA :</strong> {{ commande.total_tva|intcomma }} {{ devise_principale_symbole }}</p>
                                <p><strong>Total TTC :</strong> {{ commande.total_ttc|intcomma }} {{ devise_principale_symbole }}</p>
                            </div>
                        </div>
                        <hr>
                        <h5>Articles de la Commande</h5>
                        <table class="table table-bordered table-striped mt-3">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Quantité</th>
                                    <th>Prix Unitaire HT</th>
                                    <th>Taux TVA</th>
                                    <th>Montant HT</th>
                                    <th>Montant TVA</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ligne in commande.items.all %}
                                    <tr>
                                        <td>{{ ligne.produit.nom }}</td>
                                        <td>{{ ligne.quantite|intcomma }}</td>
                                        <td>{{ ligne.prix_unitaire|intcomma }} {{ devise_principale_symbole }}</td>
                                        <td>{{ ligne.taux_tva|intcomma }}%</td>
                                        <td>{{ ligne.montant_ht|intcomma }} {{ devise_principale_symbole }}</td>
                                        <td>{{ ligne.montant_tva|intcomma }} {{ devise_principale_symbole }}</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6">Aucun article pour cette commande.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p><strong>Notes :</strong> {{ commande.notes|default:"Aucune note." }}</p>
                    </div>
                </div>

                {# --- Section Historique des Statuts --- #}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Historique des Statuts</h5>
                    </div>
                    <div class="card-body">
                        {% if status_history %}
                            <ul class="list-group list-group-flush">
                                {% for history in status_history %}
                                    <li class="list-group-item">
                                        De **{{ history.get_ancien_statut_display|default:"N/A" }}** à **{{ history.get_nouveau_statut_display }}**
                                        par {{ history.changed_by.username|default:"Système" }} le {{ history.changed_at|date:"d/m/Y H:i" }}
                                        {% if history.commentaire %}<br><small class="text-muted">Commentaire: {{ history.commentaire }}</small>{% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucun historique de statut pour cette commande.</p>
                        {% endif %}
                    </div>
                </div>

                {# --- Section Journal d'Audit (spécifique à cette commande) --- #}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Journal d'Audit de la Commande</h5>
                    </div>
                    <div class="card-body">
                        {% if audit_logs %}
                            <ul class="list-group list-group-flush">
                                {% for log in audit_logs %}
                                    <li class="list-group-item">
                                        [{{ log.performed_at|date:"d/m/Y H:i" }}] <strong>{{ log.get_action_display }}</strong>: {{ log.description }}
                                        par {{ log.performed_by.username|default:"Système" }}
                                        {% if log.details %}<br><small class="text-muted">Détails: {{ log.details }}</small>{% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucun événement d'audit enregistré pour cette commande.</p>
                        {% endif %}
                    </div>
                </div>

                <a href="{% url 'ventes:commande_list' %}" class="btn btn-secondary mt-3">Retour à la liste des commandes</a>
            </div>
        </div>
    </div>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}État de la Caisse{% endblock %}

{% block content %}
<div class="odoo-view">
    <div class="o_control_panel d-flex justify-content-between align-items-center mb-4">
        <div class="o_cp_left">
            <h1 class="text-white mb-0">État de la Caisse</h1>
        </div>
        <div class="o_cp_right">
            {% if caisse %}
                <a href="{% url 'ventes:cloturer_caisse' %}" class="btn btn-danger me-2">
                    <i class="fas fa-lock me-2"></i> Clôturer Caisse
                </a>
            {% else %}
                <a href="{% url 'ventes:ouvrir_caisse' %}" class="btn btn-primary">
                    <i class="fas fa-unlock me-2"></i> Ouvrir Caisse
                </a>
            {% endif %}
            <a href="{% url 'ventes:journal_caisse' %}" class="btn btn-secondary ms-2">
                <i class="fas fa-book me-2"></i> Journal des Caisses
            </a>
        </div>
    </div>

    <div class="o_content">
        {% if caisse %}
            <div class="card o_form_sheet p-4 mb-4">
                <div class="card-body">
                    <h4 class="card-title text-white mb-4">Caisse Actuelle (Ouverte)</h4>
                    <dl class="row">
                        <dt class="col-sm-4 text-end text-white-50">Montant d'Ouverture :</dt>
                        <dd class="col-sm-8 text-white">{{ caisse.montant_ouverture|floatformat:2 }} FCFA</dd>

                        <dt class="col-sm-4 text-end text-white-50">Date d'Ouverture :</dt>
                        <dd class="col-sm-8 text-white">{{ caisse.date_ouverture|date:"d M Y H:i" }}</dd>

                        <dt class="col-sm-4 text-end text-white-50">Ouverte par :</dt>
                        <dd class="col-sm-8 text-white">{{ caisse.utilisateur.username }}</dd>

                        <dt class="col-sm-4 text-end text-white-50">Commentaire d'Ouverture :</dt>
                        <dd class="col-sm-8 text-white">{{ caisse.commentaire|default:"N/A" }}</dd>

                        <hr class="my-3 border-secondary">

                        <dt class="col-sm-4 text-end text-white-50">Total Encaissements Espèces :</dt>
                        <dd class="col-sm-8 text-white fw-bold">{{ total_paiements_espece|floatformat:2 }} FCFA</dd>
                        
                        <dt class="col-sm-4 text-end text-white-50">Solde Théorique Actuel :</dt>
                        <dd class="col-sm-8 text-white fw-bold fs-5">{{ solde_theorique|floatformat:2 }} FCFA</dd>
                    </dl>
                </div>
            </div>

            <h4 class="text-white mb-3">Détails des Paiements en Espèces de cette Caisse</h4>
            {% if paiements_espece %}
                <div class="card p-3">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th scope="col">Référence Paiement</th>
                                        <th scope="col">Date Paiement</th>
                                        <th scope="col">Montant</th>
                                        <th scope="col">Facture Associée</th>
                                        <th scope="col">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for paiement in paiements_espece %}
                                    <tr>
                                        <td>{{ paiement.reference_paiement|default:"-" }}</td>
                                        <td>{{ paiement.date_paiement|date:"d M Y H:i" }}</td>
                                        <td>{{ paiement.montant|floatformat:2 }} FCFA</td>
                                        <td><a href="{% url 'ventes:facture_detail' pk=paiement.facture.pk %}" class="text-info">{{ paiement.facture.reference }}</a></td>
                                        <td>{{ paiement.notes|default:"-" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <p class="text-white-50">Aucun paiement en espèces enregistré pour cette caisse.</p>
            {% endif %}

        {% else %}
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i> Aucune caisse n'est ouverte pour votre utilisateur dans cette entreprise.
            </div>
            <div class="text-center mt-4">
                <a href="{% url 'ventes:ouvrir_caisse' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-unlock me-2"></i> Ouvrir une nouvelle Caisse
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
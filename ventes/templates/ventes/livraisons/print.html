<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon de Livraison #{{ bon_livraison.numero }} - Impression</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9Oer-xYCE4uQ/QoN" crossorigin="anonymous">
    <style>
        /* Custom CSS for print layout */
        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            margin: 20mm; /* A4 margin */
        }
        .container {
            max-width: 100%; /* Override Bootstrap container width for full page */
            padding: 0;
        }
        .header, .footer {
            text-align: center;
            margin-bottom: 20px;
        }
        .details-section {
            margin-bottom: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        .text-right {
            text-align: right;
        }
        .total-section {
            width: 300px;
            margin-left: auto; /* Align to the right */
        }
        .notes {
            margin-top: 30px;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .signatures {
            margin-top: 50px;
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        .signature-block {
            width: 45%;
            text-align: center;
            border-top: 1px solid #000;
            padding-top: 5px;
        }

        /* Hide elements not for print */
        @media print {
            body {
                margin: 0;
                -webkit-print-color-adjust: exact; /* For background colors */
            }
            .no-print {
                display: none !important;
            }
            /* Ensure text color is black for printing */
            * {
                color: #000 !important;
                background-color: transparent !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            /* Specific for tables to prevent breaking */
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            thead {
                display: table-header-group;
            }
            tfoot {
                display: table-footer-group;
            }
        }
    </style>
    <style type="text/css" media="print">
        /* This section can be used for print-specific styling if needed */
        @page { size: A4; margin: 10mm; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row header">
            <div class="col-12">
                {% if entreprise_info.logo %}
                    <img src="{{ entreprise_info.logo.url }}" alt="{{ entreprise_info.nom }} Logo" style="max-height: 80px; float: left; margin-right: 20px;">
                {% endif %}
                <h3>{{ entreprise_info.nom }}</h3>
                <p>{{ entreprise_info.adresse }} - {{ entreprise_info.ville }}, {{ entreprise_info.pays }}</p>
                <p>Tel: {{ entreprise_info.telephone }} | Email: {{ entreprise_info.email }}</p>
                <hr>
            </div>
        </div>

        <div class="row details-section">
            <div class="col-6">
                <strong>Bon de Livraison N°:</strong> {{ bon_livraison.numero }}<br>
                <strong>Date du BL:</strong> {{ bon_livraison.date|date:"d/m/Y" }}<br>
                <strong>Date d'impression:</strong> {{ current_datetime|date:"d/m/Y" }}<br> {# Use current_datetime and format as date #}
                <strong>Commande N°:</strong> {{ bon_livraison.commande.numero }}<br>
            </div>
            <div class="col-6 text-end">
                <strong>Client:</strong><br>
                {{ bon_livraison.commande.client.nom }}<br>
                {% if bon_livraison.commande.client.adresse %}{{ bon_livraison.commande.client.adresse }}<br>{% endif %}
                {% if bon_livraison.commande.client.ville %}{{ bon_livraison.commande.client.ville }}{% endif %}
                {% if bon_livraison.commande.client.code_postal %}, {{ bon_livraison.commande.client.code_postal }}{% endif %}<br>
                {% if bon_livraison.commande.client.pays %}{{ bon_livraison.commande.client.pays }}<br>{% endif %}
                {% if bon_livraison.commande.client.telephone %}Tel: {{ bon_livraison.commande.client.telephone }}<br>{% endif %}
            </div>
        </div>

        <h5 class="mt-4 mb-3">Détail des articles livrés</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Description</th>
                    <th class="text-end">Quantité</th>
                    <th class="text-end">Prix Unitaire HT</th>
                    <th class="text-end">Taux TVA</th>
                    <th class="text-end">Montant HT</th>
                    <th class="text-end">Montant TVA</th>
                    <th class="text-end">Montant TTC</th>
                </tr>
            </thead>
            <tbody>
                {% for item in bon_livraison.items.all %}
                    <tr>
                        <td>{{ item.produit.nom }}</td>
                        <td class="text-end">{{ item.quantite|floatformat:2 }}</td>
                        <td class="text-end">{{ item.prix_unitaire|floatformat:2 }} {{ devise_principale_symbole }}</td>
                        <td class="text-end">{{ item.taux_tva|floatformat:2 }}%</td>
                        <td class="text-end">{{ item.montant_ht|floatformat:2 }} {{ devise_principale_symbole }}</td>
                        <td class="text-end">{{ item.montant_tva|floatformat:2 }} {{ devise_principale_symbole }}</td>
                        <td class="text-end">{{ item.montant_ht|add:item.montant_tva|floatformat:2 }} {{ devise_principale_symbole }}</td>
                    </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="text-end"><strong>Total HT:</strong></td>
                    <td class="text-end"><strong>{{ bon_livraison.total_ht|floatformat:2 }} {{ devise_principale_symbole }}</strong></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="4" class="text-end"><strong>Total TVA:</strong></td>
                    <td class="text-end"><strong>{{ bon_livraison.total_tva|floatformat:2 }} {{ devise_principale_symbole }}</strong></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="4" class="text-end"><strong>Total TTC:</strong></td>
                    <td class="text-end"><strong>{{ bon_livraison.total_ttc|floatformat:2 }} {{ devise_principale_symbole }}</strong></td>
                    <td></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

        {% if bon_livraison.notes %}
            <div class="notes">
                <strong>Notes:</strong><br>
                {{ bon_livraison.notes|linebreaksbr }}
            </div>
        {% endif %}

        <div class="signatures">
            <div class="signature-block">
                <p>Client</p>
                <br><br><br>
                <p>Nom et Signature</p>
            </div>
            <div class="signature-block">
                <p>Livreur</p>
                <br><br><br>
                <p>Nom et Signature</p>
            </div>
        </div>

        <div class="text-center mt-5 footer">
            {# Use current_datetime which is now a full datetime object #}
            <small>Généré par {{ request.user.username }} le {{ current_datetime|date:"d/m/Y H:i" }}</small>
            <p>Page 1 de 1</p> {# You might need JS to make this dynamic for multiple pages #}
        </div>
    </div>

    <script>
        // Optional: Trigger print dialog on load
        window.onload = function() {
            window.print();
        };
    </script>
</body>
</html>
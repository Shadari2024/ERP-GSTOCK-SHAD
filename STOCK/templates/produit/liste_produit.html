{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-primary text-white p-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h3 class="mb-0 text-white"><i class="fas fa-boxes me-2"></i>Gestion des Produits</h3>
                    <small class="opacity-75">Gérez efficacement votre inventaire</small>
                </div>
                <div class="d-flex align-items-center mt-2 mt-md-0">
                    <a href="{% url 'ajouter_produit' %}" class="btn btn-light btn-sm me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ajouter un produit (Ctrl+A)">
                        <i class="fas fa-plus-circle me-1"></i> Ajouter
                    </a>
                    <a href="{% url 'ajout_multiple_produits' %}" class="btn btn-light btn-sm" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ajout multiple de produits">
                        <i class="fas fa-layer-group me-1"></i> Multiple
                    </a>
                </div>
            </div>
        </div>

        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="btn-group btn-group-sm mb-2" role="group">
                    <a href="{% url 'exporter_produits_excel' %}" class="btn btn-success" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Exporter en Excel (Ctrl+E)">
                        <i class="fas fa-file-excel"></i> Excel
                    </a>
                    <a href="{% url 'imprimer_tickets_en_stock' %}" class="btn btn-danger" id="pdfPrintBtn" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Imprimer les tickets PDF (Ctrl+P)">
                        <i class="fas fa-file-pdf"></i> PDF
                    </a>
                </div>
                
                <div class="btn-group btn-group-sm mb-2" role="group">
                    <button class="btn btn-outline-secondary active view-btn" data-view="table" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Vue Tableau (T)">
                        <i class="fas fa-table"></i>
                    </button>
                    <button class="btn btn-outline-secondary view-btn" data-view="compact" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Vue Compacte (C)">
                        <i class="fas fa-list"></i>
                    </button>
                    <button class="btn btn-outline-secondary view-btn" data-view="kanban" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Vue Boîtes (K)">
                        <i class="fas fa-th-large"></i>
                    </button>
                </div>
                
                <div class="d-flex align-items-center mb-2 flex-grow-1 mx-md-3">
                    <div class="input-group input-group-sm flex-grow-1">
                        <span class="input-group-text bg-transparent border-end-0"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control border-start-0" id="searchInput" placeholder="Rechercher (Ctrl+F)...">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Effacer la recherche (Esc)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="d-flex align-items-center mb-2 ms-auto">
                    <span class="badge bg-info p-2 me-2">
                        <i class="fas fa-box me-1"></i> <span id="productCount">{{ page_obj.paginator.count }}</span> produits
                    </span>
                    <select class="form-select form-select-sm" id="deviseSelector" style="width: auto;" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Changer la devise d'affichage">
                        {% for devise in devises_acceptees %}
                            <option value="{{ devise }}" {% if devise_principale == devise %}selected{% endif %}>{{ devise }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="card-body px-0 pt-0 pb-2">
            <div class="view-container" id="tableView">
                <div class="table-responsive p-0">
                    <table class="table align-items-center mb-0" id="productTable">
                        <thead class="thead-light">
                            <tr>
                                <th class="text-uppercase text-secondary text-xs font-weight-bolder">Produit</th>
                                <th class="text-uppercase text-secondary text-xs font-weight-bolder">Description</th>
                                <th class="text-uppercase text-secondary text-xs font-weight-bolder text-center">Prix</th>
                                <th class="text-uppercase text-secondary text-xs font-weight-bolder text-center">Stock</th>
                                <th class="text-uppercase text-secondary text-xs font-weight-bolder text-center">Code-barres</th>
                                <th class="text-secondary text-xs font-weight-bolder text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            {% for produit in page_obj %}
                            <tr class="{% if produit.stock < produit.seuil_alerte %}table-warning{% endif %}" data-id="{{ produit.id }}">
                                <td>
                                    <div class="d-flex px-3 py-1">
                                        <div><img src="{% if produit.photo %}{{ produit.photo.url }}{% else %}{% static 'img/default-product.png' %}{% endif %}" class="avatar avatar-sm me-3 rounded" alt="{{ produit.nom }}"></div>
                                        <div class="d-flex flex-column justify-content-center">
                                            <h6 class="mb-0 text-sm">{{ produit.nom }}</h6>
                                            <p class="text-xs text-muted mb-0">Réf: {{ produit.reference|default:"-" }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <p class="text-xs font-weight-bold mb-0" data-bs-toggle="tooltip" title="{{ produit.description|default:'Aucune description' }}">
                                        {{ produit.description|truncatechars:40|default:"-" }}
                                    </p>
                                </td>
                                <td class="text-center">
                                    <span class="text-success text-xs font-weight-bold">
                                        <span class="prix-vente" data-prix="{{ produit.prix_vente }}">{{ produit.prix_vente|floatformat:2 }}</span> 
                                        <span class="devise-symbole">{{ devise_principale }}</span>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex flex-column align-items-center">
                                        <span class="text-xs font-weight-bold mb-1">{{ produit.stock }} unités</span>
                                        <div class="progress w-75" style="height: 5px;">
                                            <div class="progress-bar bg-{% if produit.stock < produit.seuil_alerte %}warning{% else %}success{% endif %}" role="progressbar" style="width: {% widthratio produit.stock produit.seuil_alerte 100 as progress %}{% if progress > 100 %}100{% else %}{{ progress }}{% endif %}%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% if produit.code_barre %}
                                        <div class="d-flex flex-column align-items-center">
                                            <img src="{{ produit.code_barre.url }}" alt="Code-barres" style="height: 30px;">
                                            <small class="text-muted">{{ produit.code_barre_numero|default:"" }}</small>
                                        </div>
                                    {% else %}
                                        <span class="badge bg-secondary">Non généré</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ forloop.counter }}">
                                            <li><a class="dropdown-item" href="{% url 'voir_produit' produit.id %}"><i class="fas fa-eye me-2 text-info"></i>Détails</a></li>
                                            <li><a class="dropdown-item" href="{% url 'modif_produit' produit.id %}"><i class="fas fa-edit me-2 text-primary"></i>Modifier</a></li>
                                            <li><a class="dropdown-item" href="{% url 'etiquette_produit' produit.id %}" target="_blank"><i class="fas fa-tag me-2 text-secondary"></i>Étiquette</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger delete-btn" data-id="{{ produit.id }}" data-nom="{{ produit.nom }}"><i class="fas fa-trash-alt me-2"></i>Supprimer</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center">Aucun produit trouvé.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="view-container d-none" id="compactView">
                <div class="table-responsive p-0">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Référence</th>
                                <th>Nom</th>
                                <th class="text-center">Prix Vente</th>
                                <th class="text-center">Stock</th>
                                <th class="text-center">Statut</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for produit in page_obj %}
                            <tr class="{% if produit.stock < produit.seuil_alerte %}table-warning{% endif %}" data-id="{{ produit.id }}">
                                <td>{{ produit.reference|default:"-" }}</td>
                                <td><div class="d-flex align-items-center"><img src="{% if produit.photo %}{{ produit.photo.url }}{% else %}{% static 'img/default-product.png' %}{% endif %}" class="avatar avatar-xs me-2 rounded" alt="{{ produit.nom }}">{{ produit.nom }}</div></td>
                                <td class="text-center"><span class="text-success fw-bold"><span class="prix-vente" data-prix="{{ produit.prix_vente }}">{{ produit.prix_vente|floatformat:2 }}</span> <span class="devise-symbole">{{ devise_principale }}</span></span></td>
                                <td class="text-center">{{ produit.stock }}</td>
                                <td class="text-center">
                                    {% if produit.stock < produit.seuil_alerte %}<span class="badge bg-warning text-dark">Faible</span>{% else %}<span class="badge bg-success">OK</span>{% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'voir_produit' produit.id %}" class="btn btn-outline-info" title="Détails"><i class="fas fa-eye"></i></a>
                                        <a href="{% url 'modif_produit' produit.id %}" class="btn btn-outline-primary" title="Modifier"><i class="fas fa-edit"></i></a>
                                        <a href="{% url 'etiquette_produit' produit.id %}" class="btn btn-outline-secondary" title="Étiquette" target="_blank"><i class="fas fa-tag"></i></a>
                                        <button class="btn btn-outline-danger delete-btn" data-id="{{ produit.id }}" data-nom="{{ produit.nom }}" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center">Aucun produit trouvé.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="view-container d-none" id="kanbanView">
                <div class="row mx-2">
                    {% for produit in page_obj %}
                    <div class="col-xl-3 col-lg-4 col-md-6 mb-4" data-id="{{ produit.id }}">
                        <div class="card h-100 border-0 shadow-sm {% if produit.stock < produit.seuil_alerte %}border-warning{% endif %}">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-truncate">{{ produit.nom }}</h6>
                                <span class="badge bg-info">{{ produit.reference|default:"-" }}</span>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3"><img src="{% if produit.photo %}{{ produit.photo.url }}{% else %}{% static 'img/default-product.png' %}{% endif %}" class="img-fluid rounded" style="max-height: 120px;" alt="{{ produit.nom }}"></div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Prix:</span>
                                    <span class="fw-bold text-success"><span class="prix-vente" data-prix="{{ produit.prix_vente }}">{{ produit.prix_vente|floatformat:2 }}</span> <span class="devise-symbole">{{ devise_principale }}</span></span>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1"><span class="text-muted">Stock:</span><span class="fw-bold">{{ produit.stock }}</span></div>
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar bg-{% if produit.stock < produit.seuil_alerte %}warning{% else %}success{% endif %}" role="progressbar" style="width: {% widthratio produit.stock produit.seuil_alerte 100 as progress %}{% if progress > 100 %}100{% else %}{{ progress }}{% endif %}%"></div>
                                    </div>
                                </div>
                                {% if produit.description %}<p class="small text-muted mb-3">{{ produit.description|truncatechars:60 }}</p>{% endif %}
                            </div>
                            <div class="card-footer bg-transparent border-0 d-flex justify-content-between">
                                <a href="{% url 'voir_produit' produit.id %}" class="btn btn-sm btn-outline-info" title="Détails"><i class="fas fa-eye"></i></a>
                                <a href="{% url 'modif_produit' produit.id %}" class="btn btn-sm btn-outline-primary" title="Modifier"><i class="fas fa-edit"></i></a>
                                <a href="{% url 'etiquette_produit' produit.id %}" class="btn btn-sm btn-outline-secondary" title="Étiquette" target="_blank"><i class="fas fa-tag"></i></a>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ produit.id }}" data-nom="{{ produit.nom }}" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center">Aucun produit trouvé.</div>
                    {% endfor %}
                </div>
            </div>

            {% if page_obj.paginator.num_pages > 1 %}
            <div class="px-4 pt-3">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&devise={{ devise_active }}"><i class="fas fa-angle-left"></i></a></li>{% endif %}
                        <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>
                        {% if page_obj.has_next %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&devise={{ devise_active }}"><i class="fas fa-angle-right"></i></a></li>{% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white"><h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirmation de suppression</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body text-center py-4"><div class="mb-3"><i class="fas fa-trash-alt fa-4x text-danger"></i></div><h5>Supprimer "<span id="modalProductName"></span>" ?</h5><p class="text-muted">Cette action est irréversible et supprimera définitivement le produit.</p></div>
            <div class="modal-footer justify-content-center border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Annuler</button>
                <form method="post" id="deleteForm">{% csrf_token %}<button type="submit" class="btn btn-danger"><i class="fas fa-trash-alt me-1"></i> Supprimer</button></form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Styles CSS */
    .card-header.bg-gradient-primary { background: linear-gradient(195deg, #2c3e50 0%, #1a252f 100%); }
    .avatar { width: 40px; height: 40px; object-fit: cover; border-radius: 8px; }
    .table thead th { font-size: 0.75rem; letter-spacing: 0.5px; padding: 12px 16px; background-color: #f8f9fa !important; }
    .view-btn.active { background-color: #e9ecef !important; border-color: #dee2e6 !important; color: #495057 !important; }
    .view-container.d-none { display: none; }
    .table-warning { background-color: rgba(255, 193, 7, 0.1) !important; }
    #kanbanView .card { transition: all 0.3s ease-in-out; }
    #kanbanView .card:hover { transform: translateY(-3px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important; }
    .dropdown-menu { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); border: none; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation des infobulles (tooltips)
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });

        // Gestion du changement de vue
        const switchView = (viewName) => {
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.view-btn[data-view="${viewName}"]`).classList.add('active');
            document.querySelectorAll('.view-container').forEach(container => container.classList.add('d-none'));
            document.getElementById(`${viewName}View`).classList.remove('d-none');
            localStorage.setItem('activeView', viewName);
        };
        document.querySelectorAll('.view-btn').forEach(button => { button.addEventListener('click', function() { switchView(this.dataset.view); }); });
        
        // Charger la vue sauvegardée
        const savedView = localStorage.getItem('activeView');
        if (savedView) { switchView(savedView); } else { switchView('table'); }

        // Raccourcis clavier
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey) {
                switch (event.key) {
                    case 'a': event.preventDefault(); window.location.href = '{% url "ajouter_produit" %}'; break;
                    case 'e': event.preventDefault(); window.location.href = '{% url "exporter_produits_excel" %}'; break;
                    case 'p': event.preventDefault(); document.getElementById('pdfPrintBtn').click(); break;
                    case 'f': event.preventDefault(); document.getElementById('searchInput').focus(); break;
                }
            } else {
                switch (event.key.toLowerCase()) {
                    case 't': switchView('table'); break;
                    case 'c': switchView('compact'); break;
                    case 'k': switchView('kanban'); break;
                    case 'escape': 
                        if (document.activeElement === document.getElementById('searchInput')) {
                            document.getElementById('searchInput').value = '';
                            document.getElementById('clearSearch').click();
                        }
                        break;
                }
            }
        });
        
        // Gestion de la recherche
        const originalRows = Array.from(document.querySelectorAll('#productTableBody tr, #compactView tbody tr, #kanbanView .col-xl-3'));
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            originalRows.forEach(el => {
                const text = el.innerText.toLowerCase();
                el.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        document.getElementById('clearSearch').addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            originalRows.forEach(el => { el.style.display = ''; });
        });
        
        // Gestion de la suppression
        document.addEventListener('click', function(e) {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const productId = deleteBtn.getAttribute('data-id');
                const productName = deleteBtn.getAttribute('data-nom');
                document.getElementById('modalProductName').textContent = productName;
                document.getElementById('deleteForm').action = `/produits/supprimer/${productId}/`;
                const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                modal.show();
            }
        });
        
        // Changement dynamique de devise
        document.getElementById('deviseSelector').addEventListener('change', function () {
            const nouvelleDevise = this.value;
            const symboles = {'USD': '$', 'EUR': '€', 'CDF': 'FC', 'XAF': 'CFA', 'XOF': 'CFA'};
            const devisePrincipale = '{{ devise_principale }}';

            fetch(`/api/taux-change/?devise=${nouvelleDevise}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    const taux = data.taux;
                    document.querySelectorAll('.prix-vente').forEach(el => {
                        const prix = parseFloat(el.getAttribute('data-prix'));
                        const prixConverti = nouvelleDevise === devisePrincipale ? prix : (prix * taux).toFixed(2);
                        el.textContent = prixConverti;
                    });
                    document.querySelectorAll('.devise-symbole').forEach(el => {
                        el.textContent = symboles[nouvelleDevise] || nouvelleDevise;
                    });
                    const url = new URL(window.location);
                    url.searchParams.set('devise_active', nouvelleDevise);
                    window.history.replaceState({}, '', url);
                })
                .catch(error => alert("Erreur de conversion: " + error.message));
        });
    });
</script>
{% endblock %}
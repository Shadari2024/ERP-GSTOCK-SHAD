{% extends 'base.html' %}
{% load filters %}
{% load math_filters %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-book mr-2"></i>Journal de Caisse
            </h6>
            <div>
                <button class="btn btn-sm btn-secondary" onclick="window.print()">
                    <i class="fas fa-print mr-1"></i> Imprimer
                </button>
                <a href="#" class="btn btn-sm btn-success ml-2" id="exportExcel">
                    <i class="fas fa-file-excel mr-1"></i> Excel
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- Filtres -->
            <form method="get" class="mb-4">
                <div class="row">
                    <div class="col-md-2">
                        <label>Date début</label>
                        <input type="date" name="date_debut" value="{{ date_debut }}" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label>Date fin</label>
                        <input type="date" name="date_fin" value="{{ date_fin }}" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label>Compte</label>
                        <select name="compte" class="form-control">
                            <option value="">Tous les comptes</option>
                            {% for compte in comptes %}
                            <option value="{{ compte.id }}" {% if request.GET.compte == compte.id|stringformat:"s" %}selected{% endif %}>
                                {{ compte.nom }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Devise</label>
                        <select name="devise" class="form-control">
                            {% for devise in devises_disponibles %}
                            <option value="{{ devise }}" {% if devise == devise_affichee %}selected{% endif %}>
                                {{ devise }} {% if devise == devise_principale %}(par défaut){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter mr-1"></i> Filtrer
                        </button>
                    </div>
                </div>
            </form>

            <!-- Résumé -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Total Entrées</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        {{ total_entrees|floatformat:2 }} {{ devise_affichee }}
                                        {% if devise_affichee != devise_principale %}
                                        <small class="text-muted">({{ total_entrees|convertir_devise:devise_principale|floatformat:2 }} {{ devise_principale }})</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-arrow-down fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-left-danger shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                        Total Sorties</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        {{ total_sorties|floatformat:2 }} {{ devise_affichee }}
                                        {% if devise_affichee != devise_principale %}
                                        <small class="text-muted">({{ total_sorties|convertir_devise:devise_principale|floatformat:2 }} {{ devise_principale }})</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-arrow-up fa-2x text-danger"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Solde Net</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        {{ total_entrees|subtract:total_sorties|floatformat:2 }} {{ devise_affichee }}
                                        {% if devise_affichee != devise_principale %}
                                        <small class="text-muted">({{ total_entrees|subtract:total_sorties|convertir_devise:devise_principale|floatformat:2 }} {{ devise_principale }})</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-balance-scale fa-2x text-info"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
<!-- Tableau des transactions -->
<div class="table-responsive">
    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
        <thead class="thead-light">
            <tr>
                <th>Date</th>
                <th>Compte</th>
                <th>Type</th>
                <th>Catégorie</th>
                <th>Description</th>
                <th>Mode Paiement</th>
                <th class="text-right">Montant</th>
            </tr>
        </thead>
        <tbody>
            {% for item in transactions_page %}
            {% with transaction=item.original %}
            <tr>
                <td>{{ transaction.date_transaction|date:"d/m/Y H:i" }}</td>
                <td>{{ transaction.compte.nom }}</td>
                <td>
                    <span class="badge badge-{% if transaction.type_transaction == 'ENTREE' %}success{% else %}danger{% endif %}">
                        {{ transaction.get_type_transaction_display }}
                    </span>
                </td>
                <td>{{ transaction.categorie.nom|default:"-" }}</td>
                <td>{{ transaction.description|truncatechars:40 }}</td>
                <td>{{ transaction.get_mode_paiement_display }}</td>
                <td class="text-right font-weight-bold {% if transaction.type_transaction == 'ENTREE' %}text-success{% else %}text-danger{% endif %}">
                    {% if transaction.type_transaction == 'ENTREE' %}+{% else %}-{% endif %}
                    {{ item.montant_converti|floatformat:2 }} {{ item.devise_affichee }}
                    {% if transaction.devise != item.devise_affichee %}
                    <small class="text-muted">({{ transaction.montant|floatformat:2 }} {{ transaction.devise }})</small>
                    {% endif %}
                </td>
            </tr>
            {% endwith %}
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">Aucune transaction trouvée</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
            <!-- Pagination -->
            {% if transactions.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if transactions.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&date_debut={{ date_debut }}&date_fin={{ date_fin }}&devise={{ devise_affichee }}{% if request.GET.compte %}&compte={{ request.GET.compte }}{% endif %}" aria-label="First">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ transactions.previous_page_number }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&devise={{ devise_affichee }}{% if request.GET.compte %}&compte={{ request.GET.compte }}{% endif %}" aria-label="Previous">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in transactions.paginator.page_range %}
                        {% if transactions.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > transactions.number|add:'-3' and num < transactions.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&devise={{ devise_affichee }}{% if request.GET.compte %}&compte={{ request.GET.compte }}{% endif %}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if transactions.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ transactions.next_page_number }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&devise={{ devise_affichee }}{% if request.GET.compte %}&compte={{ request.GET.compte }}{% endif %}" aria-label="Next">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ transactions.paginator.num_pages }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&devise={{ devise_affichee }}{% if request.GET.compte %}&compte={{ request.GET.compte }}{% endif %}" aria-label="Last">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Export Excel Script -->
<script>
document.getElementById('exportExcel').addEventListener('click', function() {
    // Récupérer les paramètres actuels
    let params = new URLSearchParams(window.location.search);
    
    // Construire l'URL d'export
    let exportUrl = "{% url 'export_journal_excel' %}?" + params.toString();
    
    // Télécharger le fichier
    window.location.href = exportUrl;
});
</script>

<style>
    @media print {
        .card-header, .btn, .pagination, .filter-form {
            display: none !important;
        }
        .table-responsive {
            overflow: visible !important;
        }
        body {
            background: white;
            font-size: 12pt;
        }
        .badge {
            border: 1px solid #000;
            color: #000;
            background: none !important;
        }
    }
    .table th {
        white-space: nowrap;
        position: sticky;
        top: 0;
        background-color: #f8f9fc;
    }
    .card-header {
        background: linear-gradient(45deg, #4e73df, #224abe);
    }
    .text-success {
        color: #1cc88a !important;
    }
    .text-danger {
        color: #e74a3b !important;
    }
    .badge-success {
        background-color: #1cc88a;
    }
    .badge-danger {
        background-color: #e74a3b;
    }
    .text-muted {
        font-size: 0.8rem;
        color: #6c757d !important;
    }
</style>
{% endblock %}
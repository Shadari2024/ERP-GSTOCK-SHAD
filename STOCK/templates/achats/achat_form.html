{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-cart-plus text-primary me-2"></i>Nouvel Achat
        </h2>
        <a href="{% url 'achat_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations de l'achat</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="achatForm">
                        {% csrf_token %}
                        
                        <div class="row g-3 mb-4">
                            <!-- Fournisseur -->
                            <div class="col-md-6">
                                <label for="{{ form.fournisseur.id_for_label }}" class="form-label">Fournisseur</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-truck"></i></span>
                                    {{ form.fournisseur }}
                                </div>
                                {% if form.fournisseur.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.fournisseur.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Produit -->
                            <div class="col-md-6">
                                <label for="{{ form.produit.id_for_label }}" class="form-label">Produit</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-box"></i></span>
                                    {{ form.produit }}
                                </div>
                                {% if form.produit.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.produit.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Quantité -->
                            <div class="col-md-4">
                                <label for="{{ form.quantite.id_for_label }}" class="form-label">Quantité</label>
                                <div class="input-group">
                                    <input type="number" 
                                           name="quantite" 
                                           id="id_quantite" 
                                           class="form-control" 
                                           min="1" 
                                           step="1"
                                           pattern="\d*"
                                           inputmode="numeric"
                                           required
                                           value="{{ form.quantite.value|default_if_none:'' }}">
                                    <span class="input-group-text">unités</span>
                                </div>
                                {% if form.quantite.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.quantite.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Prix unitaire -->
                            <div class="col-md-4">
                                <label for="{{ form.prix_unitaire.id_for_label }}" class="form-label">Prix unitaire</label>
                                <div class="input-group">
                                    {% if config_saas.devise_principale.symbole_avant %}
                                        <span class="input-group-text">{{ config_saas.devise_principale.symbole }}</span>
                                    {% endif %}
                                    {{ form.prix_unitaire }}
                                    {% if not config_saas.devise_principale.symbole_avant %}
                                        <span class="input-group-text">{{ config_saas.devise_principale.symbole }}</span>
                                    {% endif %}
                                </div>
                                {% if form.prix_unitaire.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.prix_unitaire.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Devise -->
                            <div class="col-md-4">
                                <label for="{{ form.devise.id_for_label }}" class="form-label">Devise</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-money-bill-wave"></i></span>
                                    {{ form.devise }}
                                </div>
                                {% if form.devise.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.devise.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Date d'achat -->
                            <div class="col-md-6">
                                <label for="{{ form.date_achat.id_for_label }}" class="form-label">Date d'achat</label>
                                <div class="input-group">
                                    {{ form.date_achat }}
                                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                </div>
                                {% if form.date_achat.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.date_achat.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Numéro de facture -->
                            <div class="col-md-6">
                                <label for="{{ form.numero_facture.id_for_label }}" class="form-label">N° Facture</label>
                                <div class="input-group">
                                    <span class="input-group-text">#</span>
                                    {{ form.numero_facture }}
                                </div>
                                {% if form.numero_facture.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.numero_facture.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Notes -->
                            <div class="col-12">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                                {{ form.notes }}
                            </div>
                            
                            <!-- Bouton de soumission -->
                            <div class="col-12 mt-3">
                                <button type="submit" class="btn btn-primary px-4 py-2 w-100">
                                    <i class="fas fa-save me-2"></i>Enregistrer l'achat
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Récapitulatif</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold">Prix unitaire:</span>
                        <span id="displayPrix">0 {{ config_saas.devise_principale.symbole }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold">Quantité:</span>
                        <span id="displayQuantite">0</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold">Devise:</span>
                        <span id="displayDevise">{{ config_saas.devise_principale.code }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold fs-5">Total:</span>
                        <span class="fw-bold fs-4 text-success" id="totalAchat">0 {{ config_saas.devise_principale.symbole }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Récupération des éléments
    const quantiteInput = document.getElementById('id_quantite');
    const prixInput = document.getElementById('id_prix_unitaire');
    const deviseSelect = document.getElementById('id_devise');
    const displayQuantite = document.getElementById('displayQuantite');
    const displayPrix = document.getElementById('displayPrix');
    const displayDevise = document.getElementById('displayDevise');
    const totalSpan = document.getElementById('totalAchat');
    const form = document.getElementById('achatForm');

    // Fonction de calcul et d'affichage
    function updateCalculs() {
        const quantite = parseInt(quantiteInput.value) || 0;  // Utilisation de parseInt au lieu de parseFloat
        const prix = parseFloat(prixInput.value) || 0;
        const devise = deviseSelect.options[deviseSelect.selectedIndex].text;
        const total = quantite * prix;
        
        // Mise à jour des affichages
        displayQuantite.textContent = quantite;
        displayPrix.textContent = prix.toFixed(2) + ' {{ config_saas.devise_principale.symbole }}';
        displayDevise.textContent = devise;
        totalSpan.textContent = total.toFixed(2) + ' {{ config_saas.devise_principale.symbole }}';
    }

    // Validation avant soumission
    form.addEventListener('submit', function(e) {
        if (quantiteInput.value.includes('.')) {
            e.preventDefault();
            alert('La quantité doit être un nombre entier');
            quantiteInput.focus();
            return false;
        }
    });

    // Écouteurs d'événements
    quantiteInput.addEventListener('input', function() {
        // Supprime automatiquement les décimales
        if (this.value.includes('.')) {
            this.value = this.value.split('.')[0];
        }
        updateCalculs();
    });
    
    prixInput.addEventListener('input', updateCalculs);
    deviseSelect.addEventListener('change', updateCalculs);
    
    // Initialisation
    updateCalculs();
    
    // Amélioration de l'UX pour les champs numériques
    [quantiteInput, prixInput].forEach(input => {
        input.addEventListener('focus', function() {
            this.select();
        });
        
        // Empêcher les valeurs négatives
        input.addEventListener('change', function() {
            if (this.value < 0) this.value = 0;
        });
    });
    
    // Formatage automatique des nombres
    prixInput.addEventListener('blur', function() {
        if (this.value) {
            this.value = parseFloat(this.value).toFixed(2);
        }
    });
});
</script>

<style>
/* Styles pour les inputs */
.form-control, .form-select {
    height: calc(3rem + 2px);
    padding: 0.5rem 1rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

textarea.form-control {
    min-height: 100px;
    resize: vertical;
}

/* Styles pour les input groups */
.input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
}

/* Styles pour les labels */
.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #495057;
}

/* Styles pour les cartes */
.card {
    border: none;
    border-radius: 0.5rem;
    overflow: hidden;
}

.card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

/* Styles pour les messages d'erreur */
.invalid-feedback {
    font-size: 0.875em;
    color: #dc3545;
}

.is-invalid {
    border-color: #dc3545;
}

.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

/* Bouton principal */
.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

/* Positionnement sticky pour le récapitulatif */
.sticky-top {
    position: -webkit-sticky;
    position: sticky;
    z-index: 1020;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête amélioré -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-file-invoice-dollar text-primary me-2"></i>Détails de l'Achat
            </h2>
            <div class="d-flex align-items-center">
                {% if entreprise.logo %}
                    <img src="{{ entreprise.logo.url }}" alt="Logo {{ entreprise.nom }}" class="me-3" style="height: 40px">
                {% endif %}
                <p class="text-muted mb-0">
                    <i class="fas fa-building me-1"></i> {{ entreprise.nom }} 
                    {% if entreprise.adresse %}
                        | <i class="fas fa-map-marker-alt me-1"></i> {{ entreprise.adresse }} 
                    {% endif %}
                    {% if entreprise.telephone %}
                        | <i class="fas fa-phone me-1"></i> {{ entreprise.telephone }}
                    {% endif %}
                </p>
            </div>
        </div>
        <a href="{% url 'achat_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i> Retour
        </a>
    </div>

    <div class="row">
        <!-- Colonne principale -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations</h5>
                </div>
                <div class="card-body">
                    <!-- Infos Fournisseur et Achat -->
                    <div class="row">
                        <!-- Fournisseur -->
                        <div class="col-md-6 border-end">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="fas fa-truck me-2"></i>Fournisseur
                            </h6>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">Nom</label>
                                <p class="form-control bg-light">{{ object.fournisseur.nom }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">Type</label>
                                <p class="form-control bg-light">{{ object.fournisseur.get_type_display }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">Contact</label>
                                <div class="d-flex">
                                    <p class="form-control bg-light me-2">
                                        <i class="fas fa-phone me-1"></i> {{ object.fournisseur.telephone }}
                                    </p>
                                    <p class="form-control bg-light">
                                        <i class="fas fa-envelope me-1"></i> {{ object.fournisseur.email|default:"-" }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Détail Achat -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="fas fa-file-invoice me-2"></i>Détails Achat
                            </h6>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">Date</label>
                                <p class="form-control bg-light">{{ object.date_achat|date:"d/m/Y" }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">Numéro Facture</label>
                                <p class="form-control bg-light">{{ object.numero_facture|default:"-" }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">Enregistré par</label>
                                <p class="form-control bg-light">
                                    {% if auteur_achat %}
                                        {{ auteur_achat.get_full_name|default:auteur_achat.username }}
                                    {% else %}
                                        <span class="text-muted">Non spécifié</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">Date de création</label>
                                <p class="form-control bg-light">{{ object.created_at|date:"d/m/Y H:i" }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Produit acheté -->
                    <div class="mt-4">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="fas fa-box-open me-2"></i>Produit Acheté
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40%">Produit</th>
                                        <th class="text-center">Catégorie</th>
                                        <th class="text-center">Quantité</th>
                                        <th class="text-end">Prix Unitaire</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>{{ object.produit.nom }}</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">{{ object.produit.categorie.nom }}</span>
                                        </td>
                                        <td class="text-center">{{ object.quantite }}</td>
                                        <td class="text-end">{{ object.prix_unitaire|floatformat:2 }} {{ symbole_devise }}</td>
                                        <td class="text-end">{{ object.total_achat|floatformat:2 }} {{ symbole_devise }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Montants HT, TVA, TTC -->
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Montant HT</h6>
                                    <h4 class="text-primary">{{ object.total_achat|floatformat:2 }} {{ symbole_devise }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">TVA ({{ taux_tva }}%)</h6>
                                    <h4 class="text-danger">{{ montant_tva|floatformat:2 }} {{ symbole_devise }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Montant TTC</h6>
                                    <h4 class="text-success">{{ montant_ttc|floatformat:2 }} {{ symbole_devise }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne droite -->
        <div class="col-lg-4">
            <!-- Stock -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Mouvement de Stock</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="small text-muted mb-1">Stock avant achat</label>
                        <p class="form-control bg-light">{{ stock_avant }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted mb-1">Quantité ajoutée</label>
                        <p class="form-control bg-light text-success fw-bold">+{{ object.quantite }}</p>
                    </div>
                    <div class="mb-0">
                        <label class="small text-muted mb-1">Nouveau stock</label>
                        <p class="form-control bg-light fw-bold">{{ object.produit.stock }}</p>
                    </div>
                </div>
            </div>
       
            <!-- Notes -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Notes</h5>
                </div>
                <div class="card-body">
                    {% if object.notes %}
                        <div class="form-floating">
                            <textarea class="form-control bg-light" style="height: 120px" readonly>{{ object.notes }}</textarea>
                            <label>Notes internes</label>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Aucune note enregistrée</p>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            {% if can_edit or can_delete or can_create_transaction %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if can_edit %}
                       <a href="{% url 'achat_update' object.pk %}" class="btn btn-outline-primary"> 
                            <i class="fas fa-edit me-2"></i> Modifier
                        </a>
                        {% endif %}
                        
                        {% if can_create_transaction %}
                        <a href="{% url 'creer_transaction_achat' object.pk %}" class="btn btn-outline-success">
                            <i class="fas fa-exchange-alt me-2"></i> Créer transaction
                        </a>
                        {% endif %}
                        
                        {% if can_delete %}
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="fas fa-trash-alt me-2"></i> Supprimer
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de suppression -->
{% if can_delete %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cet achat ? Cette action est irréversible.</p>
                <p class="fw-bold">Produit: {{ object.produit.nom }}</p>
                <p class="fw-bold">Quantité: {{ object.quantite }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form method="post" action="{% url 'achat_delete' object.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-2"></i> Confirmer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.card {
    border: none;
    border-radius: 0.5rem;
}
.card-header {
    border-radius: 0.5rem 0.5rem 0 0 !important;
}
.form-control[readonly] {
    background-color: #f8f9fa;
    cursor: default;
}
.table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}
.hover-scale {
    transition: transform 0.2s ease;
}
.hover-scale:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}
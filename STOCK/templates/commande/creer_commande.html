{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
  <div class="card shadow-lg">
    <div class="card-header bg-gradient-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0"><i class="bi bi-cart-plus me-2"></i>Nouvelle Commande</h3>
      </div>
    </div>

    <div class="card-body p-4">
      {% if perms.STOCK.add_commande and perms.security.effectuer_vente %}
        <form method="POST" action="{% url 'creer_commande' %}" class="needs-validation" novalidate>
          {% csrf_token %}

          <div class="row mb-4">
            <div class="col-md-4 mb-3">
              <label for="client" class="form-label fw-bold">Client <span class="text-danger">*</span></label>
              {% if perms.STOCK.view_client %}
                <select class="form-select" name="client" id="client" required>
                  <option value="" selected disabled>-- S√©lectionnez un client --</option>
                  {% for client in clients %}
                    <option
                        value="{{ client.id }}"
                        data-taux-remise="{{ client.taux_remise|default:'0.00' }}"
                        data-limite-credit="{{ client.limite_credit|default:'0.00' }}"
                        data-delai-paiement="{{ client.delai_paiement|default:'0' }}"
                        data-solde-creance="{{ client.solde_creance_total|default:'0.00' }}"
                        data-symbole-devise="{{ devise_principale_obj.symbole|default:'‚Ç¨' }}"
                    >
                        {{ client.nom }}
                    </option>
                  {% endfor %}
                </select>
                <div class="invalid-feedback">Veuillez s√©lectionner un client.</div>
              {% else %}
                <div class="alert alert-warning py-2 mb-0">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  Permission requise pour voir les clients
                </div>
              {% endif %}
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label fw-bold">Mode de paiement <span class="text-danger">*</span></label>
               <select class="form-select" name="paiement" id="paiement" required> {# Added ID for JS #}
                <option value="" selected disabled>-- S√©lectionnez un mode --</option>
                <option value="cash">üíµ Paiement comptant</option>
                <option value="terme">üìÖ Paiement √† terme (cr√©dit)</option> {# Changed from 30j to terme for flexibility #}
              </select>

              <div class="invalid-feedback">Veuillez s√©lectionner un mode de paiement.</div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label fw-bold">Date d'√©ch√©ance <span class="text-danger">*</span></label>
              <input type="date" class="form-control" name="expiration" id="expiration_date" required>
              <div class="invalid-feedback">Veuillez saisir une date valide.</div>
            </div>
          </div>

          <div class="row mb-4 bg-light p-3 rounded shadow-sm">
            <div class="col-md-6">
                <h5 class="text-primary mb-3"><i class="bi bi-info-circle me-2"></i>Infos Client S√©lectionn√©</h5>
                <p class="mb-1">Remise Client : <strong id="client-remise">0.00%</strong></p>
                <p class="mb-1">Limite de Cr√©dit : <strong id="client-limite-credit">0.00 {{ devise_principale_obj.symbole }}</strong></p>
                <p class="mb-1">Solde Cr√©ance Actuel : <strong id="client-solde-creance">0.00 {{ devise_principale_obj.symbole }}</strong></p>
            </div>
            <div class="col-md-6">
                <h5 class="text-primary mb-3"><i class="bi bi-exclamation-triangle me-2"></i>Alertes Cr√©ance</h5>
                <div id="credit-alert-messages">
                    <p class="text-muted">Aucune alerte pour l'instant.</p>
                </div>
            </div>
          </div>

          <div class="mb-4">
            <h5 class="text-primary mb-3"><i class="bi bi-list-ul me-2"></i>Articles command√©s</h5>
            
            <div class="table-responsive rounded-3 border">
              <table class="table table-hover align-middle mb-0" id="ligne-table">
                <thead class="table-light">
                  <tr>
                    <th width="35%">Produit</th>
                    <th width="15%">Quantit√©</th>
                    <th width="20%">Prix Unitaire</th>
                    <th width="20%">Total Ligne</th>
                    <th width="10%">Actions</th>
                  </tr>
                </thead>
                <tbody id="ligne-body">
                  <!-- Premi√®re ligne par d√©faut -->
                  <tr>
                    <td>
                      {% if perms.STOCK.view_produit %}
                        <select name="produit[]" class="form-select produit-select" required>
                          <option value="" selected disabled>-- S√©lectionnez un produit --</option>
                          {% for produit in produits %}
                            <option
                                value="{{ produit.id }}"
                                data-stock="{{ produit.stock }}"
                                data-prix-vente="{{ produit.prix_vente|default:'0.00' }}"
                            >
                                {{ produit.nom }} (Stock: {{ produit.stock }})
                            </option>
                          {% endfor %}
                        </select>
                        <div class="invalid-feedback product-stock-feedback"></div>
                      {% else %}
                        <div class="alert alert-warning py-2 mb-0">
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          Permission requise pour voir les produits
                        </div>
                      {% endif %}
                    </td>
                    <td>
                      <input type="number" name="quantite[]" class="form-control quantite-input" value="1" min="1" required>
                      <div class="invalid-feedback">Veuillez saisir une quantit√© valide.</div>
                    </td>
                    <td>
                      <div class="input-group">
                        <span class="input-group-text devise-symbole">{{ devise_principale_obj.symbole }}</span>
                        <input type="number" name="prix_unitaire[]" step="0.01" class="form-control prix-unitaire-input" value="0.00" required>
                        <div class="invalid-feedback">Veuillez saisir un prix unitaire valide.</div>
                      </div>
                    </td>
                    <td class="ligne-total fw-bold text-end">0.00 {{ devise_principale_obj.symbole }}</td>
                    <td class="text-center">
                      <button type="button" class="btn btn-outline-danger btn-sm btn-supprimer-ligne" disabled>
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            {% if perms.STOCK.view_produit %}
              <button type="button" class="btn btn-outline-primary mt-3" id="btn-ajouter-ligne">
                <i class="bi bi-plus-circle me-1"></i> Ajouter une ligne
              </button>
            {% endif %}
          </div>

          <div class="row justify-content-end mt-4">
            <div class="col-md-5">
              <div class="card border-0 bg-light">
                <div class="card-body">
                  <h5 class="card-title text-end mb-3">D√©tails de la Commande</h5>
                  <p class="d-flex justify-content-between">
                    <span>Total Brut Articles:</span>
                    <strong id="total-brut-articles" class="text-end">0.00 {{ devise_principale_obj.symbole }}</strong>
                  </p>
                  <p class="d-flex justify-content-between text-success">
                    <span>Remise Client (<span id="remise-pourcentage-display">0.00%</span>):</span>
                    <strong id="montant-remise-display" class="text-end">- 0.00 {{ devise_principale_obj.symbole }}</strong>
                  </p>
                  <hr>
                  <h3 class="d-flex justify-content-between text-primary">
                    <span>Total Net Commande:</span>
                    <strong id="total-general" class="text-end">0.00 {{ devise_principale_obj.symbole }}</strong>
                  </h3>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between mt-5">
            <a href="{% url 'liste_commandes' %}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-1"></i> Annuler
            </a>
            {% if perms.STOCK.view_client and perms.STOCK.view_produit %}
              <button type="submit" class="btn btn-success px-4">
                <i class="bi bi-check-circle me-1"></i> Enregistrer la commande
              </button>
            {% else %}
              <button type="button" class="btn btn-success px-4 disabled" title="Permissions insuffisantes">
                <i class="bi bi-lock me-1"></i> Permissions manquantes
              </button>
            {% endif %}
          </div>
        </form>
      {% else %}
        <div class="alert alert-danger">
          <div class="d-flex align-items-center">
            <i class="bi bi-shield-lock fs-3 me-3"></i>
            <div>
              <h4 class="alert-heading">Acc√®s refus√©</h4>
              <p class="mb-0">Vous n'avez pas les permissions n√©cessaires pour cr√©er des commandes.</p>
              <p class="mb-0">Contactez votre administrateur pour obtenir les droits appropri√©s.</p>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .card {
    border: none;
    border-radius: 0.75rem;
    overflow: hidden;
  }
  .card-header {
    border-radius: 0 !important;
    padding: 1.25rem 1.5rem;
  }
  .bg-gradient-primary {
    background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  }
  .table th {
    font-weight: 500;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }
  .form-control, .form-select {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
  }
  .form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  .was-validated .form-control:invalid,
  .was-validated .form-select:invalid {
    border-color: #dc3545;
  }
  .was-validated .form-control:valid,
  .was-validated .form-select:valid {
    border-color: #198754;
  }
  .alert-warning {
    background-color: rgba(255, 193, 7, 0.1);
    border-color: rgba(255, 193, 7, 0.25);
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // R√©cup√©ration des √©l√©ments DOM
    const clientSelect = document.getElementById('client');
    const paiementSelect = document.getElementById('paiement');
    const expirationDateInput = document.getElementById('expiration_date');
    const ligneBody = document.getElementById('ligne-body');
    const btnAjouterLigne = document.getElementById('btn-ajouter-ligne');
    const totalBrutArticlesDisplay = document.getElementById('total-brut-articles');
    const remisePourcentageDisplay = document.getElementById('remise-pourcentage-display');
    const montantRemiseDisplay = document.getElementById('montant-remise-display');
    const totalGeneralDisplay = document.getElementById('total-general');
    const clientRemiseDisplay = document.getElementById('client-remise');
    const clientLimiteCreditDisplay = document.getElementById('client-limite-credit');
    const clientSoldeCreanceDisplay = document.getElementById('client-solde-creance');
    const creditAlertMessages = document.getElementById('credit-alert-messages');

    // Variables d'√©tat
    let currentClientRemise = 0;
    let currentClientLimiteCredit = 0;
    let currentClientSoldeCreance = 0;
    let currentClientDelaiPaiement = 0;
    const deviseSymbole = '{{ devise_principale_obj.symbole }}';

    // Initialisation des boutons de suppression
    updateDeleteButtons();

    // √âv√©nements
    if (btnAjouterLigne) {
        btnAjouterLigne.addEventListener('click', ajouterLigne);
    }

    if (clientSelect) {
        clientSelect.addEventListener('change', updateClientInfo);
    }

    if (paiementSelect) {
        paiementSelect.addEventListener('change', updateExpirationDate);
        paiementSelect.addEventListener('change', function() {
            calculerTotalsGeneraux();
        });
    }

    // Fonctions
    function updateDeleteButtons() {
        const rows = ligneBody.querySelectorAll('tr');
        const deleteButtons = ligneBody.querySelectorAll('.btn-supprimer-ligne');
        
        deleteButtons.forEach((btn, index) => {
            btn.disabled = rows.length <= 1;
            if (rows.length > 1) {
                btn.onclick = function() { supprimerLigne(this); };
            }
        });
    }

    function ajouterLigne() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>
                <select name="produit[]" class="form-select produit-select" required>
                    <option value="" selected disabled>-- S√©lectionnez un produit --</option>
                    {% for produit in produits %}
                        <option
                            value="{{ produit.id }}"
                            data-stock="{{ produit.stock }}"
                            data-prix-vente="{{ produit.prix_vente|default:'0.00' }}"
                        >
                            {{ produit.nom }} (Stock: {{ produit.stock }})
                        </option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback product-stock-feedback"></div>
            </td>
            <td>
                <input type="number" name="quantite[]" class="form-control quantite-input" value="1" min="1" required>
                <div class="invalid-feedback">Veuillez saisir une quantit√© valide.</div>
            </td>
            <td>
                <div class="input-group">
                    <span class="input-group-text devise-symbole">${deviseSymbole}</span>
                    <input type="number" name="prix_unitaire[]" step="0.01" class="form-control prix-unitaire-input" value="0.00" required>
                    <div class="invalid-feedback">Veuillez saisir un prix unitaire valide.</div>
                </div>
            </td>
            <td class="ligne-total fw-bold text-end">0.00 ${deviseSymbole}</td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm btn-supprimer-ligne">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        ligneBody.appendChild(newRow);
        attachEventListenersToRow(newRow);
        updateDeleteButtons();
        calculerTotalsGeneraux();
    }

    function supprimerLigne(button) {
        const row = button.closest('tr');
        row.remove();
        updateDeleteButtons();
        calculerTotalsGeneraux();
    }

    function attachEventListenersToRow(row) {
        const selectProduit = row.querySelector('.produit-select');
        const quantiteInput = row.querySelector('.quantite-input');
        const prixUnitaireInput = row.querySelector('.prix-unitaire-input');

        if (selectProduit) {
            selectProduit.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const prixVente = parseFloat(selectedOption.dataset.prixVente) || 0;
                prixUnitaireInput.value = prixVente.toFixed(2);
                calculerTotalsGeneraux();
            });
        }

        quantiteInput.addEventListener('input', calculerTotalsGeneraux);
        prixUnitaireInput.addEventListener('input', calculerTotalsGeneraux);
    }

    function updateClientInfo() {
        const selectedOption = clientSelect.options[clientSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            currentClientRemise = parseFloat(selectedOption.dataset.tauxRemise) || 0;
            currentClientLimiteCredit = parseFloat(selectedOption.dataset.limiteCredit) || 0;
            currentClientSoldeCreance = parseFloat(selectedOption.dataset.soldeCreance) || 0;
            currentClientDelaiPaiement = parseInt(selectedOption.dataset.delaiPaiement) || 0;

            clientRemiseDisplay.textContent = currentClientRemise.toFixed(2) + '%';
            clientLimiteCreditDisplay.textContent = currentClientLimiteCredit.toFixed(2) + ' ' + deviseSymbole;
            clientSoldeCreanceDisplay.textContent = currentClientSoldeCreance.toFixed(2) + ' ' + deviseSymbole;
        } else {
            currentClientRemise = 0;
            currentClientLimiteCredit = 0;
            currentClientSoldeCreance = 0;
            currentClientDelaiPaiement = 0;

            clientRemiseDisplay.textContent = '0.00%';
            clientLimiteCreditDisplay.textContent = '0.00 ' + deviseSymbole;
            clientSoldeCreanceDisplay.textContent = '0.00 ' + deviseSymbole;
        }
        
        calculerTotalsGeneraux();
        updateExpirationDate();
    }

    function updateExpirationDate() {
        const paiementType = paiementSelect.value;
        if (paiementType === 'terme' && clientSelect.value) {
            const today = new Date();
            const expirationDate = new Date(today);
            expirationDate.setDate(today.getDate() + currentClientDelaiPaiement);
            expirationDateInput.valueAsDate = expirationDate;
            expirationDateInput.readOnly = false;
        } else {
            expirationDateInput.value = '';
            expirationDateInput.readOnly = false;
        }
        expirationDateInput.required = (paiementType === 'terme');
    }

    function calculerTotalsGeneraux() {
        let totalBrut = 0;
        const rows = ligneBody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const qte = parseFloat(row.querySelector('.quantite-input').value) || 0;
            const prix = parseFloat(row.querySelector('.prix-unitaire-input').value) || 0;
            const totalLigne = qte * prix;
            
            row.querySelector('.ligne-total').textContent = totalLigne.toFixed(2) + ' ' + deviseSymbole;
            totalBrut += totalLigne;
            
            // V√©rification du stock
            const selectProduit = row.querySelector('.produit-select');
            if (selectProduit) {
                const selectedOption = selectProduit.options[selectProduit.selectedIndex];
                const stock = parseInt(selectedOption.dataset.stock) || 0;
                const inputQte = row.querySelector('.quantite-input');
                const feedbackDiv = row.querySelector('.product-stock-feedback');

                if (qte > stock) {
                    inputQte.classList.add('is-invalid');
                    if (feedbackDiv) feedbackDiv.textContent = `Stock insuffisant (${stock} disponible)`;
                } else {
                    inputQte.classList.remove('is-invalid');
                    if (feedbackDiv) feedbackDiv.textContent = '';
                }
            }
        });

        const montantRemise = totalBrut * (currentClientRemise / 100);
        const totalNet = totalBrut - montantRemise;

        totalBrutArticlesDisplay.textContent = totalBrut.toFixed(2) + ' ' + deviseSymbole;
        remisePourcentageDisplay.textContent = currentClientRemise.toFixed(2) + '%';
        montantRemiseDisplay.textContent = '- ' + montantRemise.toFixed(2) + ' ' + deviseSymbole;
        totalGeneralDisplay.textContent = totalNet.toFixed(2) + ' ' + deviseSymbole;

        checkCreditLimit(totalNet);
    }

    function checkCreditLimit(currentOrderTotalNet = 0) {
        const paiementType = paiementSelect.value;
        creditAlertMessages.innerHTML = '';

        if (paiementType === 'terme' && clientSelect.value) {
            const nouveauSoldeCreance = currentClientSoldeCreance + currentOrderTotalNet;
            const limiteCredit = currentClientLimiteCredit;

            if (limiteCredit > 0 && nouveauSoldeCreance > limiteCredit) {
                const alertHtml = `
                    <div class="alert alert-danger py-2 mb-2">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <strong>D√©passement Limite de Cr√©dit !</strong><br>
                        Limite: ${limiteCredit.toFixed(2)} ${deviseSymbole}. Solde Actuel: ${currentClientSoldeCreance.toFixed(2)} ${deviseSymbole}.<br>
                        Apr√®s cette commande: ${nouveauSoldeCreance.toFixed(2)} ${deviseSymbole}.
                    </div>
                `;
                creditAlertMessages.innerHTML = alertHtml;
            } else if (limiteCredit > 0) {
                const remainingCredit = limiteCredit - nouveauSoldeCreance;
                const alertHtml = `
                    <div class="alert alert-info py-2 mb-2">
                        <i class="bi bi-info-circle me-2"></i>
                        Cr√©dit disponible: ${remainingCredit.toFixed(2)} ${deviseSymbole}.
                    </div>
                `;
                creditAlertMessages.innerHTML = alertHtml;
            }
        }
    }

    // Attacher les √©v√©nements √† la premi√®re ligne
    if (ligneBody.firstElementChild) {
        attachEventListenersToRow(ligneBody.firstElementChild);
    }

    // Initialiser les calculs
    updateClientInfo();
});
</script>
{% endblock %}
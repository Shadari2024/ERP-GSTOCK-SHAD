{% extends "comptabilite/base.html" %}
{% load static %}

{% block title %}Grand Livre{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Grand Livre</li>
{% endblock %}

{% block page_title %}Grand Livre Comptable{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title">Grand Livre Comptable</h5>
        <p class="card-subtitle text-muted">Consultation des mouvements par compte</p>
    </div>
    <div class="card-body">
        <!-- Filtres -->
        <div class="row mb-4">
            <div class="col-md-4">
                <select class="form-select" id="compte-select" name="compte">
                    <option value="">Sélectionner un compte</option>
                    {% for compte in comptes %}
                    <option value="{{ compte.numero }}" {% if compte_selectionne and compte_selectionne.numero == compte.numero %}selected{% endif %}>
                        {{ compte.numero }} - {{ compte.intitule }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" id="date-debut" name="date_debut" 
                       value="{{ filters.date_debut }}" placeholder="Date début">
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" id="date-fin" name="date_fin" 
                       value="{{ filters.date_fin }}" placeholder="Date fin">
            </div>
            <div class="col-md-2">
                <button type="button" id="filter-btn" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-1"></i> Filtrer
                </button>
            </div>
        </div>

        {% if compte_selectionne %}
        <!-- En-tête du compte -->
        <div class="alert alert-info mb-4">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-1">Compte: <strong>{{ compte_selectionne.numero }} - {{ compte_selectionne.intitule }}</strong></h6>
                    <p class="mb-0 small">Type: 
                        {% if compte_selectionne.type_compte == 'actif' %}
                            <span class="badge bg-info">Actif</span>
                        {% elif compte_selectionne.type_compte == 'passif' %}
                            <span class="badge bg-success">Passif</span>
                        {% elif compte_selectionne.type_compte == 'charge' %}
                            <span class="badge bg-danger">Charge</span>
                        {% elif compte_selectionne.type_compte == 'produit' %}
                            <span class="badge bg-primary">Produit</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 text-end">
                    <h6 class="mb-1">Solde final: 
                        <span class="{% if solde_final >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ solde_final|floatformat:2 }} {{ devise_principale_symbole }}
                        </span>
                    </h6>
                </div>
            </div>
        </div>

        <!-- Tableau du Grand Livre -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>Journal</th>
                        <th>N° Pièce</th>
                        <th>Libellé</th>
                        <th class="text-end">Débit ({{ devise_principale_symbole }})</th>
                        <th class="text-end">Crédit ({{ devise_principale_symbole }})</th>
                        <th class="text-end">Solde ({{ devise_principale_symbole }})</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Solde initial -->
                    <tr class="table-warning">
                        <td colspan="6" class="text-end"><strong>Solde initial:</strong></td>
                        <td class="text-end"><strong>0.00</strong></td>
                    </tr>
                    
                    {% for ligne in lignes %}
                    <tr>
                        <td>{{ ligne.ecriture.date_ecriture|date:"d/m/Y" }}</td>
                        <td>
                            <span class="badge bg-secondary">{{ ligne.ecriture.journal.code }}</span>
                        </td>
                        <td>{{ ligne.ecriture.piece_justificative|default:"-" }}</td>
                        <td>
                            {{ ligne.ecriture.libelle }}
                            {% if ligne.libelle and ligne.libelle != ligne.ecriture.libelle %}
                                <br><small class="text-muted">{{ ligne.libelle }}</small>
                            {% endif %}
                        </td>
                        <td class="text-end">{{ ligne.debit|floatformat:2 }}</td>
                        <td class="text-end">{{ ligne.credit|floatformat:2 }}</td>
                        <td class="text-end {% if ligne.solde_cumule >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <strong>{{ ligne.solde_cumule|floatformat:2 }}</strong>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-search fa-3x mb-3"></i>
                                <h5>Aucun mouvement trouvé</h5>
                                <p>Aucune écriture pour ce compte sur la période sélectionnée.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="4" class="text-end">Totaux:</th>
                        <th class="text-end">{{ total_debit|floatformat:2 }}</th>
                        <th class="text-end">{{ total_credit|floatformat:2 }}</th>
                        <th class="text-end">{{ solde_final|floatformat:2 }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Statistiques -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ lignes|length }}</h5>
                        <p class="card-text">Mouvements</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ total_debit|floatformat:2 }}</h5>
                        <p class="card-text">Total Débit</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ total_credit|floatformat:2 }}</h5>
                        <p class="card-text">Total Crédit</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card {% if solde_final >= 0 %}bg-warning{% else %}bg-danger{% endif %} text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ solde_final|floatformat:2 }}</h5>
                        <p class="card-text">Solde Final</p>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Message de sélection -->
        <div class="text-center py-5">
            <div class="text-muted">
                <i class="fas fa-book-open fa-4x mb-3"></i>
                <h4>Grand Livre Comptable</h4>
                <p class="mb-4">Sélectionnez un compte comptable pour afficher ses mouvements</p>
                
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <select class="form-select" id="compte-select-initial" onchange="location = '?compte=' + this.value;">
                            <option value="">Choisir un compte...</option>
                            {% for compte in comptes %}
                            <option value="{{ compte.numero }}">{{ compte.numero }} - {{ compte.intitule }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Appliquer les filtres
        $('#filter-btn').click(function() {
            const compte = $('#compte-select').val();
            const dateDebut = $('#date-debut').val();
            const dateFin = $('#date-fin').val();
            
            let url = '{% url "comptabilite:grand_livre" %}?';
            
            if (compte) url += `compte=${compte}&`;
            if (dateDebut) url += `date_debut=${dateDebut}&`;
            if (dateFin) url += `date_fin=${dateFin}&`;
            
            // Supprimer le dernier '&' si présent
            if (url.endsWith('&')) url = url.slice(0, -1);
            
            window.location.href = url;
        });

        // Entrée dans les champs déclenche le filtre
        $('#date-debut, #date-fin').keypress(function(e) {
            if (e.which === 13) {
                $('#filter-btn').click();
            }
        });

        // Changement de compte
        $('#compte-select').change(function() {
            $('#filter-btn').click();
        });

        // Initialiser les dates si vides
        if (!$('#date-debut').val()) {
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            $('#date-debut').val(firstDay.toISOString().split('T')[0]);
        }

        if (!$('#date-fin').val()) {
            $('#date-fin').val(new Date().toISOString().split('T')[0]);
        }
    });
</script>

<style>
    .table th {
        background-color: #2c3e50;
        color: white;
    }
    
    .table-dark th {
        background-color: #34495e;
    }
    
    .table-responsive {
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
</style>
{% endblock %}
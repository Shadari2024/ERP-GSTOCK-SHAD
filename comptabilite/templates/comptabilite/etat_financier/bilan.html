{% extends "comptabilite/base.html" %}
{% load static humanize %}

{% block title %}Bilan Comptable - {{ entreprise.nom }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="#">Comptabilité</a></li>
<li class="breadcrumb-item active" aria-current="page">Bilan Comptable</li>
{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h4 class="mb-1">Bilan Comptable</h4>
        <p class="text-muted mb-0">Situation patrimoniale au {{ date_fin|date:"d/m/Y" }}</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <span class="badge {% if equilibre %}bg-success{% else %}bg-danger{% endif %} fs-6">
            {% if equilibre %}
                <i class="fas fa-check-circle me-1"></i> Équilibré
            {% else %}
                <i class="fas fa-exclamation-triangle me-1"></i> Déséquilibré
            {% endif %}
        </span>
    </div>
</div>
{% endblock %}

{% block actions %}
<div class="d-flex gap-2">
    <div class="input-group" style="width: 200px;">
        <span class="input-group-text bg-white"><i class="fas fa-calendar-alt text-muted"></i></span>
        <input type="date" class="form-control border-start-0" id="date-fin" value="{{ date_fin }}">
    </div>
    
    <button type="button" id="filter-btn" class="btn btn-outline-primary">
        <i class="fas fa-filter me-1"></i> Appliquer
    </button>
    
    <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-download me-1"></i> Exporter
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exporterBilan('pdf')"><i class="fas fa-file-pdf me-2 text-danger"></i>PDF</a></li>
            <li><a class="dropdown-item" href="#" onclick="exporterBilan('excel')"><i class="fas fa-file-excel me-2 text-success"></i>Excel</a></li>
            <li><a class="dropdown-item" href="#" onclick="exporterBilan('csv')"><i class="fas fa-file-csv me-2 text-info"></i>CSV</a></li>
        </ul>
    </div>
    
    <button class="btn btn-outline-secondary" onclick="window.print()">
        <i class="fas fa-print me-1"></i> Imprimer
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Cartes de synthèse -->
    <div class="col-xxl-3 col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">TOTAL ACTIF</h6>
                        <h3 class="text-primary mb-0">{{ total_actif|floatformat:2|intcomma }} {{ devise_principale_symbole }}</h3>
                    </div>
                    <div class="avatar avatar-sm bg-primary-light">
                        <i class="fas fa-building text-primary fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="badge bg-primary-light text-primary">Actif</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xxl-3 col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">TOTAL PASSIF</h6>
                        <h3 class="text-success mb-0">{{ total_passif|floatformat:2|intcomma }} {{ devise_principale_symbole }}</h3>
                    </div>
                    <div class="avatar avatar-sm bg-success-light">
                        <i class="fas fa-hand-holding-usd text-success fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="badge bg-success-light text-success">Passif</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xxl-3 col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">RÉSULTAT NET</h6>
                        <h3 class="{% if resultat >= 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                            {{ resultat|floatformat:2|intcomma }} {{ devise_principale_symbole }}
                        </h3>
                    </div>
                    <div class="avatar avatar-sm {% if resultat >= 0 %}bg-success-light{% else %}bg-danger-light{% endif %}">
                        <i class="fas fa-chart-line {% if resultat >= 0 %}text-success{% else %}text-danger{% endif %} fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="badge {% if resultat >= 0 %}bg-success-light text-success{% else %}bg-danger-light text-danger{% endif %}">
                        {{ resultat|floatformat:2 }}%
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xxl-3 col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">ÉQUILIBRE</h6>
                        <h3 class="{% if equilibre %}text-success{% else %}text-danger{% endif %} mb-0">
                            {{ difference|floatformat:2|intcomma }} {{ devise_principale_symbole }}
                        </h3>
                    </div>
                    <div class="avatar avatar-sm {% if equilibre %}bg-success-light{% else %}bg-danger-light{% endif %}">
                        <i class="fas fa-balance-scale {% if equilibre %}text-success{% else %}text-danger{% endif %} fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="badge {% if equilibre %}bg-success{% else %}bg-danger{% endif %}">
                        {% if equilibre %}Équilibré{% else %}Déséquilibré{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bilan détaillé -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Détail du Bilan</h5>
            <div class="text-muted small">
                <i class="fas fa-info-circle me-1"></i>
                Arrêté au {{ date_fin|date:"d/m/Y" }}
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="row g-0">
            <!-- Colonne ACTIF -->
            <div class="col-lg-6 border-end">
                <div class="p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h6 class="text-primary mb-0">
                            <i class="fas fa-building me-2"></i>ACTIFS
                        </h6>
                        <span class="badge bg-primary">{{ total_actif|floatformat:2|intcomma }} {{ devise_principale_symbole }}</span>
                    </div>
                    
                    <!-- Immobilisations -->
                    {% if actif_data.2.details %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase small text-muted mb-0">IMMOBILISATIONS</h6>
                            <span class="badge bg-gray-200 text-dark">{{ actif_data.2.total|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    {% for detail in actif_data.2.details %}
                                    <tr>
                                        <td class="ps-3">
                                            <small class="text-muted">{{ detail.compte.numero }}</small><br>
                                            <span class="fw-medium">{{ detail.compte.intitule }}</span>
                                        </td>
                                        <td class="text-end fw-bold">{{ detail.solde|floatformat:2|intcomma }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Stocks -->
                    {% if actif_data.3.details %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase small text-muted mb-0">STOCKS</h6>
                            <span class="badge bg-gray-200 text-dark">{{ actif_data.3.total|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    {% for detail in actif_data.3.details %}
                                    <tr>
                                        <td class="ps-3">
                                            <small class="text-muted">{{ detail.compte.numero }}</small><br>
                                            <span class="fw-medium">{{ detail.compte.intitule }}</span>
                                        </td>
                                        <td class="text-end fw-bold">{{ detail.solde|floatformat:2|intcomma }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Créances -->
                    {% if actif_data.4.details %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase small text-muted mb-0">CRÉANCES</h6>
                            <span class="badge bg-gray-200 text-dark">{{ actif_data.4.total|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    {% for detail in actif_data.4.details %}
                                    <tr>
                                        <td class="ps-3">
                                            <small class="text-muted">{{ detail.compte.numero }}</small><br>
                                            <span class="fw-medium">{{ detail.compte.intitule }}</span>
                                        </td>
                                        <td class="text-end fw-bold">{{ detail.solde|floatformat:2|intcomma }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Trésorerie -->
                    {% if actif_data.5.details %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase small text-muted mb-0">TRÉSORERIE</h6>
                            <span class="badge bg-gray-200 text-dark">{{ actif_data.5.total|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    {% for detail in actif_data.5.details %}
                                    <tr>
                                        <td class="ps-3">
                                            <small class="text-muted">{{ detail.compte.numero }}</small><br>
                                            <span class="fw-medium">{{ detail.compte.intitule }}</span>
                                        </td>
                                        <td class="text-end fw-bold">{{ detail.solde|floatformat:2|intcomma }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Total Actif -->
                    <div class="border-top pt-3 mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="text-primary mb-0">TOTAL ACTIF</h6>
                            <h5 class="text-primary mb-0">{{ total_actif|floatformat:2|intcomma }} {{ devise_principale_symbole }}</h5>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Colonne PASSIF -->
            <div class="col-lg-6">
                <div class="p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h6 class="text-success mb-0">
                            <i class="fas fa-hand-holding-usd me-2"></i>PASSIFS
                        </h6>
                        <span class="badge bg-success">{{ total_passif|floatformat:2|intcomma }} {{ devise_principale_symbole }}</span>
                    </div>
                    
                    <!-- Capitaux propres -->
                    {% if passif_data.1.details %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase small text-muted mb-0">CAPITAUX PROPRES</h6>
                            <span class="badge bg-gray-200 text-dark">{{ passif_data.1.total|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    {% for detail in passif_data.1.details %}
                                    <tr>
                                        <td class="ps-3">
                                            <small class="text-muted">{{ detail.compte.numero }}</small><br>
                                            <span class="fw-medium">{{ detail.compte.intitule }}</span>
                                        </td>
                                        <td class="text-end fw-bold">{{ detail.solde|floatformat:2|intcomma }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Résultat net -->
                        <div class="bg-light rounded p-3 mt-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-medium">Résultat net de l'exercice</span>
                                <span class="fw-bold {% if resultat >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ resultat|floatformat:2|intcomma }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Dettes -->
                    {% if passif_data.4.details %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase small text-muted mb-0">DETTES</h6>
                            <span class="badge bg-gray-200 text-dark">{{ passif_data.4.total|floatformat:2|intcomma }}</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                    {% for detail in passif_data.4.details %}
                                    <tr>
                                        <td class="ps-3">
                                            <small class="text-muted">{{ detail.compte.numero }}</small><br>
                                            <span class="fw-medium">{{ detail.compte.intitule }}</span>
                                        </td>
                                        <td class="text-end fw-bold">{{ detail.solde|floatformat:2|intcomma }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Total Passif -->
                    <div class="border-top pt-3 mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="text-success mb-0">TOTAL PASSIF</h6>
                            <h5 class="text-success mb-0">{{ total_passif|floatformat:2|intcomma }} {{ devise_principale_symbole }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Indicateur d'équilibre -->
<div class="card border-0 shadow-sm mt-4">
    <div class="card-body text-center">
        <div class="row align-items-center">
            <div class="col-md-4 text-md-start">
                <h6 class="mb-1">Équilibre du Bilan</h6>
                <p class="text-muted mb-0">Actif = Passif + Capitaux propres</p>
            </div>
            <div class="col-md-4">
                <div class="d-flex justify-content-center align-items-center">
                    <div class="progress" style="height: 8px; width: 200px;">
                        <div class="progress-bar {% if equilibre %}bg-success{% else %}bg-danger{% endif %}" 
                             style="width: 100%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <h5 class="{% if equilibre %}text-success{% else %}text-danger{% endif %} mb-0">
                    {% if equilibre %}
                        <i class="fas fa-check-circle me-2"></i>Équilibré
                    {% else %}
                        <i class="fas fa-exclamation-triangle me-2"></i>Déséquilibré
                    {% endif %}
                </h5>
                <p class="text-muted mb-0">Différence: {{ difference|floatformat:2|intcomma }} {{ devise_principale_symbole }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Pied de page professionnel -->
<div class="text-center mt-4 py-3 text-muted border-top">
    <small>
        <i class="fas fa-print me-1"></i>Document généré le {% now "d/m/Y à H:i" %} | 
        {{ entreprise.nom }} - Système de gestion comptable
    </small>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Appliquer les filtres
        $('#filter-btn').click(function() {
            const dateFin = $('#date-fin').val();
            let url = '{% url "comptabilite:bilan" %}?';
            if (dateFin) url += `date_fin=${dateFin}`;
            window.location.href = url;
        });

        // Entrée dans le champ date déclenche le filtre
        $('#date-fin').keypress(function(e) {
            if (e.which === 13) {
                $('#filter-btn').click();
            }
        });

        // Initialiser la date si vide
        if (!$('#date-fin').val()) {
            $('#date-fin').val(new Date().toISOString().split('T')[0]);
        }
    });

    function exporterBilan(format) {
        const dateFin = '{{ date_fin }}';
        let exportUrl;
        
        if (format === 'pdf') {
            exportUrl = `{% url "comptabilite:bilan-export-pdf" %}?date_fin=${dateFin}`;
        } else if (format === 'excel') {
            exportUrl = `{% url "comptabilite:bilan-export-excel" %}?date_fin=${dateFin}`;
        } else if (format === 'csv') {
            {% comment %} exportUrl = `{% url "comptabilite:bilan-export-csv" %}?date_fin=${dateFin}`; {% endcomment %}
        } else {
            alert(`Le format d'exportation "${format}" n'est pas pris en charge.`);
            return;
        }

        window.location.href = exportUrl;
    }
</script>

<style>
    .card {
        border: 1px solid #e3e6f0;
        border-radius: 0.5rem;
        transition: all 0.15s ease-in-out;
    }
    
    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .avatar {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
    }
    
    .avatar-sm {
        width: 2.5rem;
        height: 2.5rem;
    }
    
    .bg-primary-light {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .bg-success-light {
        background-color: rgba(25, 135, 84, 0.1);
    }
    
    .bg-danger-light {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .bg-gray-200 {
        background-color: #e9ecef;
    }
    
    .table-borderless td {
        border: none;
        padding: 0.5rem 0.25rem;
    }
    
    .table-borderless tr:hover {
        background-color: #f8f9fa;
    }
    
    .border-end {
        border-right: 1px solid #e3e6f0 !important;
    }
    
    @media (max-width: 991.98px) {
        .border-end {
            border-right: none !important;
            border-bottom: 1px solid #e3e6f0 !important;
        }
    }
    
    /* Styles d'impression */
    @media print {
        .btn, .dropdown, .breadcrumb, .actions {
            display: none !important;
        }
        
        .card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
        }
        
        .text-primary, .text-success {
            color: #000 !important;
        }
    }
</style>
{% endblock %}
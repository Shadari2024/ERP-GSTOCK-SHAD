{% extends "achats/base_achats.html" %}
{% load achats_tags %}
{% load commande_tags %} {# Assuming 'commande_tags' provides get_statut_color and similar functions #}

{% block page_title %}Détail Commande #{{ commande.numero_commande }}{% endblock %}

{% block achats_content %}
<div class="erp-detail-container">
    <div class="erp-card">
        <div class="erp-card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
            <div class="d-flex align-items-center mb-2 mb-md-0">
                <h2 class="erp-card-title">
                    Commande d'Achat #{{ commande.numero_commande }}
                </h2>
                <span class="erp-status-badge erp-status-{{ commande.statut }}"
                      data-tooltip="Statut actuel de la commande : {{ commande.get_statut_display }}.">
                    {{ commande.get_statut_display }}
                </span>
            </div>
            
            {% if commande.statut != 'livree' and perms.achats.add_bonreception %}
<div class="mt-3">
    <form action="{% url 'achats:creer_bon_automatique' commande.pk %}" method="post">
        {% csrf_token %}
        <button type="submit" class="erp-btn erp-btn-success"
                data-tooltip="Créer automatiquement un bon de réception pour toutes les lignes non livrées">
            <i class="bi bi-magic"></i> Créer bon de réception automatique
        </button>
    </form>
</div>
{% endif %}
            <div class="erp-btn-group">
                {% if commande.statut == 'brouillon' %}
                <a href="{% url 'achats:modifier_commande' commande.pk %}" class="erp-btn erp-btn-warning"
                   data-tooltip="Modifier les détails de cette commande (disponible seulement en brouillon).">
                    <i class="bi bi-pencil"></i> Modifier
                </a>
                {% if can_validate %}
                <form action="{% url 'achats:valider_commande' commande.pk %}" method="post" class="d-inline-block">
                    {% csrf_token %}
                    <button type="submit" class="erp-btn erp-btn-primary"
                            data-tooltip="Valider cette commande d'achat. Elle ne pourra plus être modifiée une fois validée.">
                        <i class="bi bi-check-circle"></i> Valider
                    </button>
                </form>
                {% endif %}
                {% endif %}
                <a href="{% url 'achats:liste_commandes' %}" class="erp-btn erp-btn-secondary"
                   data-tooltip="Retourner à la liste complète des commandes d'achat.">
                    <i class="bi bi-arrow-left"></i> Retour
                </a>
            </div>
        </div>

        <div class="erp-card-body">
            <div class="row mb-4">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <div class="erp-info-box">
                        <h5 class="erp-section-title"><i class="bi bi-info-circle mr-2"></i>Informations Générales</h5>
                        <div class="erp-table-responsive">
                            <table class="erp-info-table">
                                <tr>
                                    <th data-tooltip="Nom du fournisseur associé à cette commande.">Fournisseur:</th>
                                    <td class="info-value">{{ commande.fournisseur.nom }}</td>
                                </tr>
                                <tr>
                                    <th data-tooltip="Date à laquelle cette commande a été créée.">Date commande:</th>
                                    <td class="info-value">{{ commande.date_commande|date:"d/m/Y" }}</td>
                                </tr>
                                <tr>
                                    <th data-tooltip="Date prévue pour la livraison des articles.">Date livraison:</th>
                                    <td class="info-value">{{ commande.date_livraison_prevue|date:"d/m/Y" }}</td>
                                </tr>
                                <tr>
                                    <th data-tooltip="La devise utilisée pour cette commande.">Devise:</th>
                                    <td class="info-value">
                                        {% if devise_principale %}
                                            <span class="erp-badge erp-badge-info"
                                                  data-tooltip="Code et symbole de la devise.">
                                                {{ devise_principale.code }} ({{ devise_principale.symbole }})
                                            </span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                   <!-- Dans la section des totaux -->
<div class="erp-info-box">
    <h5 class="erp-section-title"><i class="bi bi-calculator mr-2"></i>Totaux de la Commande</h5>
    <div class="erp-table-responsive">
        <table class="erp-total-table">
            <tr>
                <th data-tooltip="Montant total des produits avant taxes.">Montant HT:</th>
                <td class="text-right erp-total-value">
                    {{ commande.total_ht|floatformat:2 }}
                    {% if devise_principale %}{{ devise_principale.symbole }}{% endif %}
                </td>
            </tr>
            <tr>
                <th data-tooltip="Montant total de la Taxe sur la Valeur Ajoutée (TVA).">TVA:</th>
                <td class="text-right erp-total-value">
                    {{ commande.total_tva|floatformat:2 }}
                    {% if devise_principale %}{{ devise_principale.symbole }}{% endif %}
                </td>
            </tr>
            <tr class="font-weight-bold erp-total-row">
                <th data-tooltip="Montant total de la commande toutes taxes comprises (TTC).">Montant TTC:</th>
                <td class="text-right erp-total-final">
                    {{ commande.total_ttc|floatformat:2 }}
                    {% if devise_principale %}{{ devise_principale.symbole }}{% endif %}
                </td>
            </tr>
        </table>
    </div>
</div>
            </div>

            <div class="erp-info-box mb-4">
                <h5 class="erp-section-title"><i class="bi bi-list-ul mr-2"></i>Lignes de Commande</h5>
                <div class="erp-table-responsive">
                    <table class="erp-line-table">
                        <thead class="erp-thead">
                            <tr>
                                <th>Produit</th>
                                <th>Code</th>
                                <th class="text-right">Quantité</th>
                                <th class="text-right">Prix unitaire</th>
                                <th class="text-right">Remise</th>
                                <th class="text-right">Total HT</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ligne in lignes %}
                            <tr>
                                <td data-tooltip="Nom du produit commandé.">{{ ligne.produit.nom }}</td>
                                <td data-tooltip="Code barre ou numéro de référence du produit.">{{ ligne.produit.code_barre_numero|default:"-" }}</td>
                                <td class="text-right" data-tooltip="Quantité de ce produit commandée.">{{ ligne.quantite }}</td>
                                <td class="text-right" data-tooltip="Prix unitaire du produit.">
                                    {{ ligne.prix_unitaire|floatformat:2 }}
                                    {% if devise_principale %}{{ devise_principale.symbole }}{% endif %}
                                </td>
                                <td class="text-right" data-tooltip="Pourcentage de remise appliqué à cette ligne.">{{ ligne.remise|default:"0" }}%</td>
                                <td class="text-right" data-tooltip="Montant total hors taxes pour cette ligne de commande.">
    {{ ligne.total_ht_ligne|floatformat:2 }}
    {% if devise_principale %}{{ devise_principale.symbole }}{% endif %}
</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="erp-empty-lines">Aucune ligne de commande trouvée.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% if commande.notes %}
            <div class="erp-info-box">
                <h5 class="erp-section-title"><i class="bi bi-journal-text mr-2"></i>Notes</h5>
                <div class="erp-notes-box" data-tooltip="Notes additionnelles ou commentaires sur cette commande.">
                    {{ commande.notes|linebreaks }}
                </div>
            </div>
            {% endif %}

            {% if commande.statut != 'brouillon' %}
            <div class="mt-4 text-right">
                <a href="{% url 'achats:creer_bon' commande.pk %}" class="erp-btn erp-btn-odoo"
                   data-tooltip="Créer un bon de réception pour enregistrer la réception des produits de cette commande.">
                    <i class="bi bi-truck"></i> Créer un bon de réception
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* General ERP styles (from base_achats.html or global) */
    :root {
        --primary-color: #5b21b6; /* Deep Purple */
        --primary-color-rgb: 91, 33, 182;
        --secondary-color: #7c3aed; /* Lighter Purple */
        --secondary-color-rgb: 124, 58, 237;
        --accent-color: #2563eb; /* Blue accent */
        --accent-color-rgb: 37, 99, 235;

        --background-body: #1a202c; /* Dark background for body */
        --card-background: #2d3748; /* Slightly lighter dark for cards */
        --text-color-light: #e2e8f0; /* Light text for readability on dark backgrounds */
        --text-color-dark: #a0aec0; /* Slightly darker text for labels/less emphasis */
        --border-color: #4a5568; /* Subtle border color */
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2); /* Darker shadows */
        --transition: all 0.3s ease; /* Smooth transitions */
        --border-radius: 0.5rem; /* Consistent border radius */

        --tooltip-bg: #4a5568; /* Darker tooltip background */
        --tooltip-color: #e2e8f0; /* Light tooltip text */

        /* Status Colors - Tailored for dark theme */
        --status-brouillon-bg: rgba(248, 150, 30, 0.2); /* Soft orange for Draft */
        --status-brouillon-text: #f8961e;

        --status-validee-bg: rgba(76, 201, 240, 0.2); /* Soft light blue for Validated */
        --status-validee-text: #4cc9f0;

        --status-livree-bg: rgba(72, 149, 239, 0.2); /* Soft blue for Delivered */
        --status-livree-text: #4895ef;

        --status-annulee-bg: rgba(247, 37, 133, 0.2); /* Soft red for Canceled */
        --status-annulee-text: #f72585;

        /* Button Colors - Specific for this page's actions */
        --btn-warning-bg: #ffc107;
        --btn-warning-text: #2d3748; /* Dark text for warning */
        --btn-warning-hover-bg: #e0a800;

        --btn-success-bg: #28a745;
        --btn-success-text: white;
        --btn-success-hover-bg: #218838;

        --btn-info-bg: #17a2b8;
        --btn-info-text: white;
        --btn-info-hover-bg: #138496;
    }

    /* Odoo-like styles adaptation for dark theme */
    .erp-detail-container {
        padding: 2rem;
    }

    .erp-card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
    }
    
    .erp-card-header {
        background-color: var(--background-body); /* Slightly darker header */
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .erp-card-title {
        color: var(--text-color-light);
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
    }
    
    /* Status Badge in Header */
    .erp-status-badge {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-left: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        line-height: 1; /* Ensure text fits well */
    }

    .erp-status-brouillon {
        background-color: var(--status-brouillon-bg);
        color: var(--status-brouillon-text);
    }
    .erp-status-validee {
        background-color: var(--status-validee-bg);
        color: var(--status-validee-text);
    }
    .erp-status-livree {
        background-color: var(--status-livree-bg);
        color: var(--status-livree-text);
    }
    .erp-status-annulee {
        background-color: var(--status-annulee-bg);
        color: var(--status-annulee-text);
    }

    /* Button Group */
    .erp-btn-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
    }

    .erp-btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--border-radius);
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        text-decoration: none; /* Ensure links look like buttons */
        font-size: 0.9rem;
    }

    .erp-btn-primary {
        background-color: var(--primary-color);
        color: white;
        box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.3);
    }
    .erp-btn-primary:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(var(--primary-color-rgb), 0.5);
    }

    .erp-btn-warning {
        background-color: var(--btn-warning-bg);
        color: var(--btn-warning-text);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
    }
    .erp-btn-warning:hover {
        background-color: var(--btn-warning-hover-bg);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 193, 7, 0.3);
    }
    
    .erp-btn-secondary {
        background-color: var(--background-body);
        color: var(--text-color-light);
        border: 1px solid var(--border-color);
        box-shadow: none;
    }
    .erp-btn-secondary:hover {
        background-color: var(--dark-color); /* Assuming dark-color is defined in root */
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .erp-card-body {
        padding: 2rem;
        color: var(--text-color-light); /* Default text color for body */
    }
    
    .erp-section-title {
        color: var(--primary-color); /* Primary color for section titles */
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .erp-info-box {
        background: var(--background-body); /* Slightly darker background for info boxes */
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--box-shadow);
    }
    
    /* Tables within info boxes */
    .erp-table-responsive {
        overflow-x: auto;
    }

    .erp-info-table,
    .erp-total-table,
    .erp-line-table {
        width: 100%;
        border-collapse: collapse;
        color: var(--text-color-light);
    }
    
    .erp-info-table th,
    .erp-total-table th {
        color: var(--text-color-dark); /* Darker text for labels/headers */
        font-weight: 500;
        text-align: left;
        padding: 0.75rem 0;
        vertical-align: top;
        min-width: 120px; /* Ensure labels align */
    }

    .erp-info-table td,
    .erp-total-table td {
        padding: 0.75rem 0;
        vertical-align: top;
    }

    .erp-info-table tr,
    .erp-total-table tr {
        border-bottom: 1px solid var(--border-color); /* Subtle row separators */
    }
    .erp-info-table tr:last-child,
    .erp-total-table tr:last-child {
        border-bottom: none;
    }
    
    .erp-info-table .info-value {
        font-weight: 600;
        color: var(--accent-color); /* Accent color for values */
    }

    .erp-total-value {
        font-weight: 600;
        color: var(--text-color-light);
    }

    .erp-total-row {
        background-color: var(--card-background); /* Darker background for total row */
        font-weight: 700 !important;
        border-top: 2px solid var(--border-color); /* Stronger separator for total */
    }
    .erp-total-row th, .erp-total-row td {
        padding-top: 1rem;
        padding-bottom: 1rem;
        color: var(--primary-color); /* Primary color for final total */
        font-size: 1.1rem;
    }
    .erp-total-final {
        font-size: 1.2rem;
        color: var(--primary-color);
    }
    
    .erp-thead {
        background-color: var(--primary-color);
        color: white;
    }

    .erp-line-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .erp-line-table td {
        padding: 0.8rem 1rem;
        border: 1px solid var(--border-color); /* Visible borders for line table */
    }
    
    .erp-line-table tbody tr:nth-child(even) {
        background-color: var(--background-body); /* Alternate row background */
    }
    .erp-line-table tbody tr:hover {
        background-color: rgba(var(--primary-color-rgb), 0.08); /* Hover effect */
    }

    .erp-empty-lines {
        text-align: center;
        padding: 2rem;
        color: var(--text-color-dark);
        font-style: italic;
    }
    
    .erp-notes-box {
        background-color: var(--background-body);
        border-left: 5px solid var(--primary-color); /* Primary color stripe */
        padding: 1rem;
        border-radius: var(--border-radius);
        color: var(--text-color-light);
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .erp-badge-info {
        background-color: rgba(var(--accent-color-rgb), 0.15); /* Light accent background */
        color: var(--accent-color);
        padding: 0.25em 0.6em;
        border-radius: 0.25rem;
        font-size: 0.8em;
        font-weight: 600;
    }
    
    .erp-btn-odoo { /* Specific style for "Create receipt" button */
        background-color: var(--accent-color);
        color: white;
        box-shadow: 0 4px 12px rgba(var(--accent-color-rgb), 0.3);
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }
    .erp-btn-odoo:hover {
        background-color: #1f57ce; /* Slightly darker accent on hover */
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(var(--accent-color-rgb), 0.5);
    }
    
    /* Tooltip styles (should be in base_achats.html for global availability) */
    [data-tooltip]::after {
        content: attr(data-tooltip);
        visibility: hidden;
        opacity: 0;
        background-color: var(--tooltip-bg);
        color: var(--tooltip-color);
        text-align: center;
        border-radius: 6px;
        padding: 5px 10px;
        position: absolute;
        z-index: 1001;
        top: 120%; /* Position below element */
        left: 50%;
        transform: translateX(-50%) translateY(5px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        white-space: nowrap;
        font-size: 0.85rem;
        pointer-events: none; /* Allows clicks on elements below tooltip */
        box-shadow: var(--box-shadow);
    }

    [data-tooltip]:hover::after {
        visibility: visible;
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .erp-card-header {
            flex-direction: column;
            align-items: flex-start;
            padding: 1rem;
        }

        .erp-card-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .erp-status-badge {
            margin-left: 0;
            margin-bottom: 1rem; /* Space between badge and buttons */
            font-size: 0.8rem;
        }
        
        .erp-btn-group {
            width: 100%;
            flex-direction: column; /* Stack buttons vertically */
            gap: 0.75rem;
        }
        
        .erp-btn-group .erp-btn {
            width: 100%;
            text-align: center;
        }

        .erp-card-body {
            padding: 1.5rem;
        }

        .erp-section-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .erp-info-box {
            padding: 1rem;
        }

        .erp-info-table th, .erp-info-table td,
        .erp-total-table th, .erp-total-table td {
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .erp-line-table th, .erp-line-table td {
            padding: 0.6rem 0.8rem;
            font-size: 0.85rem;
        }

        .erp-total-row th, .erp-total-row td {
            font-size: 1rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        .erp-total-final {
            font-size: 1.1rem;
        }

        .erp-notes-box {
            padding: 0.8rem;
            font-size: 0.9rem;
        }

        .erp-btn-odoo {
            width: 100%;
            text-align: center;
        }
    }
</style>
{% endblock %}
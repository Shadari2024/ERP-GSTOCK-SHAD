{% extends "achats/base_achats.html" %}
{% load static humanize %}

{% block page_title %}Détail de la Facture {{ facture.numero_facture }}{% endblock %}

{% block achats_content %}
<div class="erp-facture-detail-container">
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom border-secondary">
        <div>
            <h2 class="erp-content-title text-light">Facture {{ facture.numero_facture }}</h2>
            <p class="text-muted mb-0">Fournisseur: <strong class="text-white">{{ facture.fournisseur.nom }}</strong></p>
        </div>
        
        <div class="d-flex gap-2">
            {% if perms.achats.change_facturefournisseur %}
            <a href="{% url 'achats:modifier_facture' facture.pk %}" class="btn btn-outline-light">
                <i class="fas fa-edit me-1"></i> Modifier
            </a>
            {% endif %}
            
            {% comment %} <button class="btn btn-outline-danger" disabled>
                <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
            <button class="btn btn-outline-success" disabled>
                <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            {% endcomment %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card bg-dark text-light mb-4 shadow">
                <div class="card-header bg-primary text-white border-bottom border-primary">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Informations de la Facture
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <strong class="text-secondary d-block">Numéro de facture</strong>
                            <span class="text-white">{{ facture.numero_facture }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong class="text-secondary d-block">Statut</strong>
                            <span class="badge bg-{% if facture.statut == 'payee' %}success{% elif facture.statut == 'partiellement_payee' %}warning text-dark{% elif facture.statut == 'validee' %}info{% else %}secondary{% endif %}">
                                {{ facture.get_statut_display }}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong class="text-secondary d-block">Date de facture</strong>
                            <span class="text-white">{{ facture.date_facture|date:"d/m/Y" }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong class="text-secondary d-block">Date d'échéance</strong>
                            <span class="text-white">{{ facture.date_echeance|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card bg-dark text-light mb-4 shadow">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped mb-0">
                            <tbody>
                                <tr>
                                    <td class="text-end border-top-0">Montant HT:</td>
                                    <td class="text-end fw-bold border-top-0">{{ facture.montant_ht|floatformat:2|intcomma }} {{ devise_principale_symbole }}</td>
                                </tr>
                                <tr>
                                    <td class="text-end">TVA:</td>
                                    <td class="text-end fw-bold">{{ facture.montant_tva|floatformat:2|intcomma }} {{ devise_principale_symbole }}</td>
                                </tr>
                                <tr>
                                    <td class="text-end fw-bold">TOTAL TTC:</td>
                                    <td class="text-end fw-bold text-primary">{{ facture.montant_ttc|floatformat:2|intcomma }} {{ devise_principale_symbole }}</td>
                                </tr>
                                <tr>
                                    <td class="text-end text-success fw-bold">Montant payé:</td>
                                    <td class="text-end text-success fw-bold">{{ facture.montant_paye|floatformat:2|intcomma }} {{ devise_principale_symbole }}</td>
                                </tr>
                                <tr>
                                    <td class="text-end fw-bold">Reste à payer:</td>
                                    <td class="text-end fw-bold text-{% if facture.reste_a_payer > 0 %}danger{% else %}success{% endif %}">
                                        {{ facture.reste_a_payer|floatformat:2|intcomma }} {{ devise_principale_symbole }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card bg-dark text-light mb-4 shadow">
                <div class="card-header bg-info text-white border-bottom border-info">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Historique des Paiements
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if paiements %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead class="bg-secondary text-light">
                                <tr>
                                    <th scope="col">Référence</th>
                                    <th scope="col">Mode</th>
                                    <th scope="col">Date</th>
                                    <th scope="col" class="text-end">Montant</th>
                                    <th scope="col">Statut</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paiement in paiements %}
                                <tr>
                                    <td>
                                        <strong>{{ paiement.reference|default:"N/A" }}</strong>
                                        {% if paiement.notes %}
                                        <br><small class="text-muted">{{ paiement.notes|truncatewords:5 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary text-light">
                                            {{ paiement.get_mode_paiement_display }}
                                        </span>
                                    </td>
                                    <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                                    <td class="text-end fw-bold text-success">
                                        {{ paiement.montant|floatformat:2|intcomma }} {{ devise_principale_symbole }}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if paiement.statut == 'valide' %}success{% elif paiement.statut == 'brouillon' %}warning text-dark{% else %}danger{% endif %}">
                                            {{ paiement.get_statut_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if perms.achats.change_paiementfournisseur %}
                                            <a href="{% url 'achats:modifier_paiement' paiement.pk %}" 
                                               class="btn btn-outline-light" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% endif %}
                                            {% if perms.achats.delete_paiementfournisseur %}
                                            <a href="{% url 'achats:supprimer_paiement' paiement.pk %}" 
                                               class="btn btn-outline-danger" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
                        <p>Aucun paiement enregistré pour cette facture.</p>
                        {% if facture.reste_a_payer > 0 %}
                        <p class="text-info">Utilisez le formulaire ci-dessous pour effectuer un premier règlement.</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            {% if facture.reste_a_payer > 0 and perms.achats.add_paiementfournisseur %}
            <div class="card bg-dark text-light shadow">
                <div class="card-header bg-success text-white border-bottom border-success">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-hand-holding-usd me-2"></i>Effectuer un Paiement
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'achats:creer_paiement_direct' facture.pk %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label small">Montant *</label>
                            <input type="number" name="montant" class="form-control bg-secondary text-white border-secondary" 
                                   step="0.01" min="0.01" max="{{ facture.reste_a_payer }}"
                                   placeholder="Montant à payer" required>
                            <div class="form-text text-muted">
                                Maximum: {{ facture.reste_a_payer|floatformat:2 }} {{ devise_principale_symbole }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Date de paiement *</label>
                            <input type="date" name="date_paiement" class="form-control bg-secondary text-white border-secondary" 
                                   value="{% now 'Y-m-d' %}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Mode de paiement *</label>
                            <select name="mode_paiement" class="form-select bg-secondary text-white border-secondary" required>
                                <option value="">Sélectionnez un mode</option>
                                <option value="virement">Virement bancaire</option>
                                <option value="cheque">Chèque</option>
                                <option value="espece">Espèces</option>
                                <option value="carte">Carte bancaire</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Référence</label>
                            <input type="text" name="reference" class="form-control bg-secondary text-white border-secondary" 
                                   placeholder="Référence du paiement">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Notes</label>
                            <textarea name="notes" class="form-control bg-secondary text-white border-secondary" rows="2" 
                                      placeholder="Notes supplémentaires"></textarea>
                        </div>
                        
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check-circle me-1"></i> Enregistrer le Paiement
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if facture.get_ecritures_comptables %}
    <div class="card bg-dark text-light mt-4 shadow">
        <div class="card-header bg-secondary text-white border-bottom border-secondary">
            <h5 class="card-title mb-0">
                <i class="fas fa-book me-2"></i>Écritures Comptables Associées
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                    <thead class="bg-secondary text-light">
                        <tr>
                            <th scope="col">Numéro</th>
                            <th scope="col">Journal</th>
                            <th scope="col">Date</th>
                            <th scope="col">Libellé</th>
                            <th scope="col" class="text-end">Montant</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ecriture in facture.get_ecritures_comptables %}
                        <tr>
                            <td>{{ ecriture.numero }}</td>
                            <td>{{ ecriture.journal.code }}</td>
                            <td>{{ ecriture.date_comptable|date:"d/m/Y" }}</td>
                            <td>{{ ecriture.libelle }}</td>
                            <td class="text-end">{{ ecriture.montant_devise|floatformat:2|intcomma }} {{ devise_principale_symbole }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #212529; /* Fond général sombre */
        color: #f8f9fa; /* Texte par défaut clair */
    }
    
    .card {
        border: 1px solid #495057; /* Bordure sombre */
        border-radius: 0.5rem;
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.4);
        margin-bottom: 1.5rem;
    }

    .card.bg-dark {
        background-color: #2c3138 !important; /* Arrière-plan de carte légèrement plus clair que le fond du body */
    }

    .card-header {
        border-bottom: 1px solid #495057 !important;
        font-weight: 600;
        border-radius: 0.5rem 0.5rem 0 0 !important;
    }
    
    .table-dark {
        --bs-table-bg: #2c3138;
        --bs-table-color: #f8f9fa;
    }

    .table-dark.table-striped > tbody > tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .table-hover tbody tr:hover {
        background-color: #343a40;
    }

    .form-control, .form-select {
        color: #f8f9fa !important;
        background-color: #343a40 !important;
        border-color: #495057 !important;
    }

    .form-control::placeholder {
        color: #ced4da;
    }

    .form-text {
        color: #999 !important;
    }

    .text-primary {
        color: #0d6efd !important;
    }

    .text-secondary {
        color: #adb5bd !important;
    }
</style>
{% endblock %}